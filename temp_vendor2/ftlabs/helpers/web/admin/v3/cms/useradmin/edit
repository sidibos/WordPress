<?php
/*
########################################################
This page allows administration of a single user in order
to edit their outline permissions; this is done by means
of an arbitary number of folder/permission settings.

Accepted Inputs:
(GET) id - htaccess username of user to edit.

18/05/2005
Rowan Beentje
Assanka Ltd
########################################################
*/

require_once($_SERVER["DOCUMENT_ROOT"]."/lib/inc/global");
require_once($_SERVER["CORE_PATH"]."/web/admin/v3/auth");

$permissions = array();

// Check permissions, error if none
checkIfAuth("content", "", true, array("administrator"));

// Check the id (htaccessuser) supplied is valid, using it to get the name
$username = $db->querySingle("SELECT name FROM cfg_adminusers WHERE htaccessuser='".$db->sqlenc($_REQUEST["id"])."'");
if (!$username) trigger_error("Expected variable id not matched to a valid username", E_USER_ERROR);

// Process a POST request if present
if ($_POST) {
	$db->query("DELETE FROM out_permissions WHERE htaccessuser='".$db->sqlenc($_POST["id"])."'");

	// If all entries have been deleted, return to the index.
	if (!is_array($_POST["tag"])) {
		$page->alert("Permissions returned to default level of full access.", "done");
	
	// Otherwise step through the submitted arrays, creating new rows for each
	} else {
		for ($i=0; $i<count($_POST["tag"]); $i++) {
		
			// Ensure we're not inserting duplicate rows
			if (!$db->querySingle("SELECT htaccessuser FROM out_permissions WHERE htaccessuser='".$db->sqlenc($_POST["id"])."' AND tag='".$db->sqlenc($_POST["tag"][$i])."' AND role='".$db->sqlenc($_POST["perms"][$i])."' AND siteid='".$db->sqlenc($_POST["site"][$i])."'")) {
				$db->query("INSERT INTO out_permissions SET htaccessuser='".$db->sqlenc($_POST["id"])."', tag='".$db->sqlenc($_POST["tag"][$i])."', role='".$db->sqlenc($_POST["perms"][$i])."', siteid='".$db->sqlenc($_POST["site"][$i])."'");
			}
		}
		$page->alert("Permissions saved.", "done");
	}

	header("Location: index");
	exit;
}

// Grab the number of sites, using it to control sites display
$multiSite = false;
$siteResult = $db->query("SELECT id, name FROM out_sites ORDER BY id ASC");
if (mysql_num_rows($siteResult) > 1) $multiSite = true;
$firstsite = $db->fetchrow($siteResult);

// Grab the permissions for this user
$result = $db->query("SELECT p.tag, p.role, p.siteid, s.name FROM out_permissions p LEFT JOIN out_sites s ON p.siteid=s.id WHERE htaccessuser='".$db->sqlenc($_REQUEST["id"])."' ORDER BY p.siteid, p.tag");
$permissions = array();

// If rows are present, build a tag/role array using them
if ($db->numresults($result)) {
	while ($row = $db->fetchrow($result)) {
		$permissions[] = $row;
	}

// If no rows, that's equivalent to a publisher access for everything
} else {
	$permissions[] = array("tag"=>"", "role"=>"publisher");
}

$page->addContent("content", "<h4 style=\"margin-top: 0px\">Outline permissions for ".$username."</h4>");
$page->addContent("content", "<script type=\"text/javascript\" src=\"".$_SERVER["CORE_WEB_ALIAS"]."/admin/v3/js/outline\"></script>");
$page->addContent("content", "<script type=\"text/javascript\">olhandler = new OutlineHandler('permissions');</script>");
$page->addContent("content", "<style type=\"text/css\">@import url(\"".$_SERVER["CORE_WEB_ALIAS"]."/admin/v3/css/outline\");</style>");

// Output all the current permissions
$count = 0;
$page->addContent("content", "<form action=\"edit\" method=\"post\" name=\"frmeditusers\"><div id=\"permissionsdiv\"><input type=\"hidden\" name=\"id\" value=\"".$_REQUEST["id"]."\" />");
foreach ($permissions as $permission) {
	if ($permission["tag"] == "homepage") $permission["tag"] = "";
	outlineUsersOutputPermissionDiv(++$count, $permission["tag"], $permission["role"], $permission["siteid"], $permission["name"], $multiSite);
	$page->addContent("content", "<script type=\"text/javascript\">addLoadEvent(function() { outlineMakeBrowseField(document.getElementById('visibletag".$count."'), 'permissions', document.getElementById('tag".$count."'), document.getElementById('site".$count."'), '".$count."', '../'); });</script>");

}
$page->addContent("content", "</div></form><div class=\"paddedcontent\"><a href=\"javascript:void(0);\" onclick=\"userrows.addLoc(this);\" accesskey=\"a\"><span style=\"text-decoration: underline;\">A</span>dd another permission location/level for this user</a></div>");

// Output the dummy div for use by javascript, and the appropriate javascript
outlineUsersOutputPermissionDiv("nnn", $permission["tag"], $permission["role"], $permission["siteid"], $permission["name"], $multiSite, true);
$page->addContent("context", "<script type=\"text/javascript\">userrows = new outlineUsersHandler();</script>");

$page->addAction("save", "Save", false, "document.frmeditusers.submit()");
$page->addAction("cancel", "Cancel", "index");

$page->render();
exit;

// This function outputs one of the location/permission divs.
function outlineUsersOutputPermissionDiv($id, $tag, $role, $siteid, $sitename, $multiSite, $jsdummy = false) {
	global $page;

	$accesslevels = array("no access", "author", "publisher");
	$permissionoptions = "";
	foreach ($accesslevels as $accesslevel) {
		$permissionoptions .= "<option value=\"".$accesslevel."\"".(($role == $accesslevel)?" selected=\"selected\"":"").">".ucfirst($accesslevel)."</option>";
	}
	
	if (!$siteid) {
		$siteid = -1;
		$sitename = "All Sites";
	}
	
	$divdetails = array("--id--"=>$id,
		"--tag--"=>$tag,
		"--siteid--"=>$siteid,
		"--sitename--"=>$sitename,
		"--permoptions--"=>$permissionoptions,
		"--multisitedisplay--"=>(($multiSite)?"block":"none"));
	
	if ($jsdummy) {
		$page->addContent("context", "<div style=\"display: none;\">".str_replace(array_keys($divdetails), array_values($divdetails), $page->loadExternalContent("html/userpermissionrow"))."</div>");
	} else {
		$page->addContent("content", str_replace(array_keys($divdetails), array_values($divdetails), $page->loadExternalContent("html/userpermissionrow")));
	}
}
?>