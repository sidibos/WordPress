<?php
/*
########################################################
Generates new traffic flow maps

04/11/2004
Andrew Betts
Assanka Ltd
########################################################
*/

require_once("statsliblink");

if (!checkIfAuth("statistics", "", false, array("premium", "server"))) {
	outputPremiumGuideAndExit(&$page);
}

$statsfolder = $_SERVER["DOCUMENT_ROOT"]."/lib/tmp/stats";

// Check for the stats folder and create if not present
if (!file_exists($statsfolder)) {
	$old_umask = umask(0);
	mkdir($statsfolder, 0777);
	umask($old_umask);
}
if (!is_writable($statsfolder)) {
	trigger_error("/lib/tmp/stats directory is not writable, and must be to create new flowmaps.", E_USER_ERROR);
}

// Construct the form with submitted or default data
$frm = new inputform("newflowmap", "POST", "new");

// Set up the paths array
$pathcounts = array("10"=>"10 paths", "20"=>"20 paths", "30"=>"30 paths", "50"=>"50 paths");

// Simple fields for paths, start date and end date
$fieldgrp = new simplefieldgroup(&$frm);
$fieldgrp->addSelect("paths", "Show", "h", true, $pathcounts);
$fieldgrp->addText("startdate", "Start month", "s", true, false, 20);
$fieldgrp->addText("enddate", "End month", "e", true, false, 20);

// Help text
$frm->addHelptext("paths", "Select the number of paths to show on this flow map.  Flow maps are drawn showing the most popular routes across the site, so choose a low number of paths to get a simplified view, or a high number of paths to get a more accurate and so more comlex view.");
$frm->addHelptext("startdate", "Enter the starting month (inclusive) you wish to calculate the popular routes from, preferably in mm/yyyy format.");
$frm->addHelptext("enddate", "Enter the end month (inclusive) you wish to calculate the popular routes from, preferably in mm/yyyy format.");

// Add action buttons
$page->addAction("submit", "Save", false, "document.frmnewflowmap.submit()");
$page->addAction("cancel", "Cancel", "index");

// Check for a submitted request.  If data has been submitted, add it to the
// form groups, and check for validity.
if ($_POST) {
	$fieldgrp->addData($_POST);
	
	$verifieddata = array();
	
	// Process dates
	$starttime = Common::convertHumanTime($_POST["startdate"]);
	if (!$starttime or $startime < 0) $fieldgrp->makeInputInvalid("startdate", "The start date you entered was not recognised.  Enter the start month in mm/yyyy format for best compatibility.");
	else $verifieddata["startdate"] = date("m/Y", $starttime);
	
	$endtime = Common::convertHumanTime($_POST["enddate"]);
	if (!$endtime or $endtime < 0) {
		$fieldgrp->makeInputInvalid("enddate", "The end date you entered was not recognised.  Enter the end month in mm/yyyy format for best compatibility.");
	} else {
		$verifieddata["enddate"] = date("m/Y", $endtime);
		if ($endtime < $starttime) $fieldgrp->makeInputInvalid("enddate", "The end date you entered cannot be before the start date!");
	}
	
	if ($fieldgrp->inputValid()) {
		$filename = date("Ym", $starttime).date("Ym", $endtime).$_POST["paths"];
		if (file_exists($statsfolder."/".$filename)) {
			$page->alert("The traffic flow map for the time period and number of paths you specified has already been created.", "warning");
		} else {
			$oldumask = umask(0);
			touch($statsfolder."/".$filename);
			chmod($statsfolder."/".$filename, 0777);
			umask($oldumask);
			
			// Start the generator if it isn't already
			startFlowMapGenerator();
		
			$page->alert("Traffic flow map created and marked for processing.", "done");
		}
		header("Location: index");
		exit;
	
	} else {
		$fieldgrp->addData($verifieddata);
		$fieldgrp->addToForm(true);

		// Define an error infobar message
		$page->alert("You did not complete the form correctly.  Please review the fields marked below - move your mouse over the underlined label for more specific error information.", "error");
	}
	
// Otherwise, provide default dates covering last month
} else {
	$data = array("startdate"=>date("m/Y", strtotime("-1 month")), "enddate"=>date("m/Y", strtotime("-1 month")));
	$fieldgrp->addData($data);
	
	$page->alert("Fill in the form below to add a new traffic flow map");

	$fieldgrp->addToForm(false);
}

// Output the form and help panel to the page
$page->addContent("content", $frm->outputForm());
$page->addContent("context", $frm->outputContextHelp());

$page->title = "Statistics - Create New Flow Map";
$page->render();

?>
