<?php
/**
 * Generic object class - provides access to databases
 *
 * @codingstandard ftlabs-phpcs
 * @copyright The Financial Times Limited [All Rights Reserved]
 */

require_once $_SERVER['CORE_PATH'] . '/vendor/autoload.php';
require_once $_SERVER['CORE_PATH']."/helpers/memcache/v1/memcacheaccess";

abstract class OrmBase {

	protected static $dbread, $dbwrite, $useutc;
	private static $mc;

	public static function initDB(FTLabs\MySqlConnection $read, FTLabs\MySqlConnection $write) {
		self::$dbread = &$read;
		self::$dbwrite = &$write;
	}

	public static function useMasterDB() {
		self::$dbread = self::$dbwrite;
	}

	public static function initMemcache($mchandle) {
		self::$mc = $mchandle;
	}

	public static function setUTC($bool) {
		self::$useutc = (bool)$bool;
	}

	protected static function sqlPlaceholder($key, $conditional=false, $mod=null) {
		$sql = "{".$key;
		if ($mod) {
			$sql .= "|".$mod;
		} elseif (isset(static::$fields[$key])) {
			$def = static::$fields[$key];
			if (in_array($def['type'], array('date', 'datetime', 'datetimeseconds', 'time', 'timeseconds'))) {
				if (self::$useutc) $sql .= "|utcdate";
				else $sql .= "|date";
			} elseif (in_array($def['type'], array('text', 'textarea', 'hidden', 'dummy', 'autocomplete', 'password', 'richtext'))) {
				$sql .= "|tostring";
			} elseif (in_array($def['type'], array('boolean', 'check'))) {
				$sql .= "|01";
			}
		}
		if ($conditional) $sql .= (strpos($sql, '|') === false) ? '|isnull' : '_isnull';
		$sql .= "}";
		return $sql;
	}

	protected static function dbread() {
		return self::$dbread;
	}

	protected static function dbwrite() {
		return self::$dbwrite;
	}

	protected static function getMemcache() {
		if (empty(self::$mc)) self::$mc = MemcacheAccess::getMemcache();
		return self::$mc;
	}
}