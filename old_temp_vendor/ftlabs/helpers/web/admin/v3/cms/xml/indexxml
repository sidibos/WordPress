<?php
/**
 * Outputs children of a folder in basic xml format; in fact this
 * file constructs and returns the html in complete form, and the
 * index page simply inserts it.
 *
 * Accepted Inputs: (GET) id: id of element to fetch the children
 * from (GET) hidedrafts: whether to hide drafts
 *
 * @copyright The Financial Times Limited [All Rights Reserved]
 */
require_once($_SERVER["DOCUMENT_ROOT"]."/lib/inc/global");
require_once($_SERVER["CORE_PATH"]."/web/admin/v3/cms/cmslib");

$authuser = ($_SERVER["PHP_AUTH_USER"])?$_SERVER["PHP_AUTH_USER"]:$_SERVER["REMOTE_USER"];
if (!$authuser) {
	echo "You no longer appear to be logged in, possibly because you haven't done anything for a significant time.  To refresh your login information, reload the page.";
	exit;
}

header("Content-Type: text/xml");

if (!is_numeric($_GET["id"])) {
	header("HTTP/1.0 400 Bad Request");
	eit;
}


// Grab the itemid
$result = $db->query("SELECT itemid, languageisocode FROM out_localcontent WHERE id=".$_GET["id"]);
if (!mysql_num_rows($result)) {
	header("HTTP/1.0 400 Bad Request");
	exit;
} else {
	$row = $db->fetchrow($result);
	$theItemID = $row["itemid"];
	$languageisocode = $row["languageisocode"];
}
$formats = $db->query("SELECT dateformat, timeformat FROM out_languages WHERE isocode='".$languageisocode."'");
$formatsrow = $db->fetchrow($formats);
$dateFormat = $formatsrow["dateformat"];
$timeFormat = $formatsrow["timeformat"];

// Begin with construction of the item; fetch all the direct children,
// including stored drafts.
$result = $db->query("SELECT out_items.id as itemid, out_items.siteid, out_localcontent.id as contentid, out_versions.id AS versionid, title, DATE_FORMAT(datecreated, '".$dateFormat." ".$timeFormat."') as datecreated, authoruser, draftuser, cfg_adminusers.name AS author, tag, visibility, islive FROM out_items LEFT JOIN out_localcontent ON out_items.id = out_localcontent.itemid LEFT JOIN out_versions ON out_localcontent.id = out_versions.localcontentid LEFT JOIN cfg_adminusers ON out_versions.authoruser=cfg_adminusers.htaccessuser WHERE parentid=".$theItemID." AND (islive=1".(($_GET["hidedrafts"] == "all")?"":" OR draftuser IS NOT NULL").") AND languageisocode='".$languageisocode."' ORDER BY draftuser IS NULL DESC, sortindex, IF(draftuser IS NULL, title, draftuser!='".$db->sqlenc($_SESSION["outlineadmin"])."') ASC, datecreated ASC");
	
// Set up a variable to store all rows, for grouping of live and drafts, before outputting at end
$rowsarray = array();
echo("<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\n");

if (!mysql_num_rows($result)) {
	?>
	<response>
	<localcontentid><?=$_GET["id"]?></localcontentid>
	<html><![CDATA[
		<div style="clear: both;">
			<div class="tdb tdnormal">
				<div class="treepad">&nbsp;</div>
				<div class="treepad"><img src="/lib/inc/loadcore/web/admin/v2/img/icons/icon16_drafthidden.gif" width="16" height="14" /></div>
				<span class="ctext hidden">(Only non-visible pages in this folder)</span>
			</div>
		</div>
	]]></html>
	</response>
	<?php
	exit;
}
?>
<response>
	<localcontentid><?=$_GET["id"]?></localcontentid>
	<html><![CDATA[
		<?php
		while ($row = $db->fetchrow($result)) {
			
			// If this row doesn't already exist in the row array, create an entry for it
			if (!$rowsarray[$row["contentid"]]) {
			
				// Before insertion, check whether this row has any children
				$result2 = $db->query("SELECT out_items.id FROM out_items WHERE parentid=".$row["itemid"]." LIMIT 0,1");
				
				$isfolder = ((mysql_num_rows($result2))?true:false);
				
				// The presence of rows indicates children; if so, display an expandable folder.
				// Also check the saved page tag to see whether the folder should be loaded expanded.
				if ($isfolder) {
					$isdeleteable = false;
					$issortable = ((cmsCheckIfAuth("sortpage", $row["tag"], false, false, $row["siteid"]))?true:false);
				} else {
					$isdeleteable = (($row["draftuser"] == "")?((cmsCheckIfAuth("deletepage", $row["tag"], false, false, $row["siteid"]))?true:false):false);
					$issortable = false;
				}
				
				$iseditable = (($_GET["extra"] and (strpos("/".$row["tag"]."/", $_GET["extra"]."/") !== false))?false:(($row["draftuser"] == "")?((cmsCheckIfAuth("editpage", $row["tag"], false, false, $row["siteid"]))?true:false):false));
				$islive = (($row["islive"] && $row["visibility"])?true:false);
				
				// Create the row entry
				$rowsarray[$row["contentid"]] = array("contentid"=>$row["contentid"], "title"=>$row["title"], "tag"=>$row["tag"], "author"=>$row["author"], "datecreated"=>$row["datecreated"], "iseditable"=>$iseditable, "isfolder"=>$isfolder, "issortable"=>$issortable, "isdeleteable"=>$isdeleteable, "islive"=>$islive, "visibility"=>$row["visibility"], "isbrowser"=>$_GET["isbrowser"], $drafthtml=>"", "firstversionid"=>$row["versionid"]);
			}
			
			// If appropriate, append a draft record
			if (!$_GET["hidedrafts"] and $row["draftuser"]) $rowsarray[$row["contentid"]]["drafthtml"] .= getDraftHTML($rowsarray[$row["contentid"]]["firstversionid"], $row["versionid"], $row["draftuser"], $row["authoruser"], $row["author"], false);
		}

		// Loop through the rows array and output each row
		foreach ($rowsarray as $row) {
			echo(getTreeViewRow($row["contentid"], $row["title"], $row["tag"], $row["author"], $row["datecreated"], $row["iseditable"], $row["isfolder"], false, $row["issortable"], $row["isdeleteable"], $row["islive"], $row["visibility"], $row["drafthtml"], $row["isbrowser"]));
		}?>
	]]></html>
</response>