<?php
/**
 * Disable a CMS page - for use with the outline toolbar
 *
 * Accepted Inputs: (GET) id: localcontentid of the item to disable
 *
 * @copyright The Financial Times Limited [All Rights Reserved]
 */

require_once($_SERVER["DOCUMENT_ROOT"]."/lib/inc/global");
require_once("cmslib");

$authuser = ($_SERVER["PHP_AUTH_USER"])?$_SERVER["PHP_AUTH_USER"]:$_SERVER["REMOTE_USER"];

if (!is_numeric($_GET["id"])) trigger_error("Expected variable id not supplied or non numeric", E_USER_ERROR);

// Check whether the user has the rights to disable pages
$result = $db->query("SELECT tag, siteid FROM out_localcontent l LEFT JOIN out_items i ON l.itemid=i.id WHERE l.id=".$_GET["id"]);
$tag = mysql_result($result, 0, "tag");
$siteid = mysql_result($result, 0, "siteid");
cmsCheckIfAuth("disablepage", $tag, $authuser, true, $siteid);

// Save the location of this page for redisplay of index
saveLastSelectedPage($tag);

// Grab details and mark versions as being disabled in the action log
$result = $db->query("SELECT out_versions.id, out_items.id AS theitemid FROM out_items LEFT JOIN out_localcontent ON out_items.id=out_localcontent.itemid LEFT JOIN out_versions ON out_localcontent.id=out_versions.localcontentid WHERE out_localcontent.id=".$_GET["id"]." AND islive=1");
while ($rec = $db->fetchrow($result)) {
	$db->query("INSERT INTO out_actionlog SET versionid=".$rec["id"].", user='".$authuser."', actiontype='disable', comment='', date=NOW()");
	$itemID = $rec["theitemid"];
}

// Disable the page itself
$db->query("UPDATE out_items SET visibility='inaccessible' WHERE id=".$itemID);

// Perform a recursive delete of the entire cache affected by links
outlineDeleteCache($siteid);

if (mysql_affected_rows()) {
	$page->alert("Page disabled successfully.", "done");
	header("Location: index");
} else {
	trigger_error("Unexpected result", E_USER_ERROR);
}
?>
