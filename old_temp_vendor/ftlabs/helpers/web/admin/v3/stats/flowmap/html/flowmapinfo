<h3>Information</h3>
<div class="paddedcontent">Traffic flow maps show the <em>routes</em> that visitors take when navigating the website.  They can take some time to process, so use the form above to set the parameters of your new map, and then the map will be generated shortly.</div>
<style type="text/css">
.pbar {
	width: 78px;
	height: 7px;
	border: 0;
	margin: 0;
	position: relative;
	top: 2px;
	padding: 0;
	background: #BBBBBB url(<!--@CORE_WEB_ALIAS-->/admin/v3/img/barempty.png) no-repeat;
	display: none;
}
.pbar div {
	width: 0px;
	height: 7px;
	border: 0;
	margin: 0;
	padding: 0;
	background: #BBBBBB url(<!--@CORE_WEB_ALIAS-->/admin/v3/img/barfull.png) no-repeat;
	float: left;
	overflow: hidden;
}
.pinfo {
	font-style: italic;
}
</style>
<script type="text/javascript">
var xmlReq;
var currfile = 0;
var stage3time = 0;
var check404 = false;
var doublecheck = true;

// Global var so we can use the appropriate code paths for IE vs Gecko/KHTML
var isInternetExplorer;
if (window.XMLHttpRequest) {
	var isInternetExplorer = false;
} else if (window.ActiveXObject) {
	var isInternetExplorer = true;
}

function getProgress() {
	if (isInternetExplorer) {
		xmlReq = new ActiveXObject("Microsoft.XMLHTTP");
	} else {
		xmlReq = new XMLHttpRequest();
	}
	xmlReq.onreadystatechange = xmlHttpRequestStateChange;
	xmlReq.open("GET", "status", true);
	xmlReq.send(null);
}
// Handle onreadystatechange events from the xmlHttpRequest.  404s generally
// mean generation has ended, so an item can be marked as complete.
function xmlHttpRequestStateChange() {
	if (!xmlReq) return false;
	if (xmlReq.readyState == 4) {
		if (xmlReq.status == 200) {
			if (xmlReq && (xmlReq.responseText != "<response></response>")) {
				processLoadedXml();
			} else if (currfile) {
				document.getElementById(currfile+'bar').style.display = 'none';
				document.getElementById(currfile+'info').style.display = 'inline';
				document.getElementById(currfile+'info').className = '';
				document.getElementById(currfile+'info').innerHTML = "<a href='view?file="+currfile+"'>View Flow Map</a>";
				window.setTimeout("getProgress();", 5000);
			} else {
				window.setTimeout("getProgress();", 5000);
			}
		} else if (xmlReq.status == 404) {
			window.setTimeout("getProgress();", 5000);
		}
	}
}
function processLoadedXml() {
	response  = xmlReq.responseXML.documentElement;
	if (response.getElementsByTagName('stage')[0]) {
		stage = response.getElementsByTagName('stage')[0].firstChild.data;
		filename = response.getElementsByTagName('pid')[0].firstChild.data;
		if (!document.getElementById(filename+'info')) return false;
		
		maxsteps = response.getElementsByTagName('maxsteps')[0].firstChild.data;
		thisstep = response.getElementsByTagName('thisstep')[0].firstChild.data;
		logtime = response.getElementsByTagName('logtime')[0].firstChild.data;
		if (currfile && (filename != currfile)) {
			document.getElementById(currfile+'bar').style.display = 'none';
			document.getElementById(currfile+'info').style.display = 'inline';
			document.getElementById(currfile+'info').className = '';
			document.getElementById(currfile+'info').innerHTML = "<a href='view?file="+currfile+"'>View Flow Map</a>";
			document.getElementById(filename+'info').style.display = 'none';
			document.getElementById(filename+'bar').style.display = 'block';
			stage3incr = 0;
		}
		if (!currfile && filename) {
			document.getElementById(filename+'info').style.display = 'none';
			document.getElementById(filename+'bar').style.display = 'block';
		}
		currfile = filename;
		
		// Maths for drawing progress bar for each stage.  The entire progress bar is 77px long.
		// Stage 1 = started. Base value of percentage - 5%.
		// Stage 2 (x/total) = list of all logs generated, iterating through logs. Total of 60%.
		// Stage 3 = generating dot file.  Usually takes a shorter time than stage 2. Total of 30%.
		// Stage 4 = generating png file. Total of 5%.
		progpercent = 5;
		if (stage == 2) {
			var stage2percent = thisstep/maxsteps;
			progpercent = 5 + (stage2percent * 60);
		}
		if (stage == 3) {
			if (stage3time == 0) {
				stage3time = parseInt(logtime);
				progpercent = 65;
			} else {
				stage3time += 2;
				var stage3percent = ((stage3time - logtime)/logtime)*2;
				if (stage3percent > 1) stage3percent = 1;
				progpercent = 65 + (30 * stage3percent);
			}
		} else {
			stage3time = 0;
		}
		if (stage == 4) {
			progpercent = 95;
		}		
		document.getElementById(currfile+'prog').style.width = (Math.round(progpercent*77/100)) + 'px';
	}
	window.setTimeout("getProgress();", 2000);
}

getProgress();
</script>
