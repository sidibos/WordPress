<?php
/**
 * Echoes a CMS page inside a basic page for formatted HTML.
 *
 * Accepted Inputs: (GET) id: id of the page to echo.
 *
 * @copyright The Financial Times Limited [All Rights Reserved]
 */

require_once($_SERVER["DOCUMENT_ROOT"]."/lib/inc/global");
require_once($_SERVER["CORE_PATH"]."/web/common/v1/formatteddifference");
require_once("cmslib");

// Error if this project does not have version control enabled
if (!cmsIsFunctionalityEnabled("versiondiff")) trigger_error(APPNAME." does not have the correct permissions to use version control.", E_USER_ERROR);

if (!$_GET["id"] || !is_numeric($_GET["id"])) trigger_error("Expected variable id not supplied or non numeric", E_USER_ERROR);

// Config **todo** - get and set the language
$languageisocode = "en";
$formats = $db->query("SELECT dateformat, timeformat FROM out_languages WHERE isocode='".$languageisocode."'");
$formatsrow = $db->fetchrow($formats);
$dateFormat = $formatsrow["dateformat"];
$timeFormat = $formatsrow["timeformat"];

// Grab the version we wish to echo
$row = $db->queryRow("SELECT v.title, v.localcontentid, v.html, v.datecreated, DATE_FORMAT(v.datecreated, '".$dateFormat." ".$timeFormat."') as modifiedlong, a.name as author, draftuser, i.type, v.islive FROM out_versions v LEFT JOIN out_localcontent l ON v.localcontentid=l.id LEFT JOIN out_items i ON l.itemid=i.id LEFT JOIN cfg_adminusers a ON v.authoruser=a.htaccessuser WHERE v.id=".$_GET["id"]);
if (!$row) trigger_error("Could not retrive requested version", E_USER_ERROR);

$cssFile = false;
if (file_exists($_SERVER["DOCUMENT_ROOT"]."/lib/css/cms")) $cssFile = "/lib/css/cms";
else if (file_exists($_SERVER["DOCUMENT_ROOT"]."/lib/css/cms.css")) $cssFile = "/lib/css/cms.css";
else if (file_exists($_SERVER["DOCUMENT_ROOT"]."/lib/css/screen")) $cssFile = "/lib/css/screen";
else if (file_exists($_SERVER["DOCUMENT_ROOT"]."/lib/css/screen.css")) $cssFile = "/lib/css/screen.css";

$htmlToEcho = "<html><head>";
if ($cssFile) $htmlToEcho .= "<link rel=\"stylesheet\" href=\"".$cssFile."\" type=\"text/css\" media=\"screen\" title=\"Screen style\" />";
$htmlToEcho .= "<title>".$row["title"]."</title></head><body style=\"padding: 10px; text-align: left;\">";

$content = array("content"=>$row["html"]);
if ($row["type"] == "asset") $htmlToEcho .= $row["html"]; 
else $htmlToEcho .= template("page-cms", $content);
$htmlToEcho .= "</body></html>";

echo $htmlToEcho;

?>