<?php

require_once($_SERVER["DOCUMENT_ROOT"]."/lib/inc/global");
include ($_SERVER["CORE_PATH"]."/web/jpgraph/1.17beta2/jpgraph.php");
include ($_SERVER["CORE_PATH"]."/web/jpgraph/1.17beta2/jpgraph_pie.php");
include ($_SERVER["CORE_PATH"]."/web/jpgraph/1.17beta2/jpgraph_pie3d.php");
if (substr($_SERVER["PATH_INFO"], 0, 5) == "/web/") include($_SERVER["CORE_PATH"]."/".substr($_SERVER["PATH_INFO"], 1, strrpos($_SERVER["PATH_INFO"], "/")-1)."/../statslib");
else include ("../statslib");

$counts = getSearchEngines(date("mY", $_GET["start"]), date("mY", $_GET["end"]));

$labels = array("msn"=>"MSN Search", "search"=>"Unknown", "google"=>"Google", "aol"=>"AOL Search", "hotbot"=>"HotBot", "yahoo"=>"Yahoo Search", "askuk"=>"Ask Jeeves UK", "google_image"=>"Google Image Search", "ask"=>"Ask Jeeves", "altavista"=>"Altavista", "ukdirectory"=>"UK Directory", "lycos"=>"Lycos", "tiscali"=>"Tiscali", "dogpile"=>"DogPile", "alltheweb"=>"All the Web", "searchy"=>"Searchy", "netscape"=>"Netscape Search", "earthlink"=>"Earthlink", "mamma"=>"Mamma", "ukplus"=>"UK Plus", "atomz"=>"Atomz", "overture"=>"Overture", "dmoz"=>"Open Directory Project", "search.com"=>"Search.com", "seznam"=>"Seznam.cz", "aolde"=>"AOL Germany", "excite"=>"Excite Search", "ixquick"=>"ixQuick Metasearch", "webcrawler"=>"WebCrawler", "alexa"=>"Alexa", "metacrawler"=>"MetaCrawler", "infospace"=>"InfoSpace", "teoma"=>"Teoma", "go2net"=>"Go2Net", "others"=>"Others");
$data = array();

// Grab the totals
$totalhits = 0;
$max = 0;
foreach ($counts as $countdata) {
	$totalhits += $countdata["hits"];
	if ($countdata["hits"] > $max) $max = $countdata["hits"];
}

if (sizeof($counts)) {
	sortArrayBasedTable(&$counts, &$counts, "hits", "ASC");
	foreach($counts as $countdata) {
		if ($countdata["hits"] > ($max/100)) {
			$data[$countdata["engine"]] = $countdata["hits"];
		} else {
			$data["others"] += $countdata["hits"];
		}
	}
} else {
	$data["others"] = 1;
}
$ydata = array_values($data);
$xdata = array_keys($data);

$legend = array();
$explode = array();
foreach($xdata as $label) $legend[] = $labels[$label];
foreach($ydata as $key=>$value) {
	if ($value > ($max/18)) $explode[] = 0;
	else $explode[] = 50;
}

// Create the graph.
$graph = new PieGraph(650,350,"auto");	
$graph->title->Set("Referrals from search engines");
$graph->title->SetFont(FF_ARIAL, FS_NORMAL, 12);
$graph->SetFrame(true, "#F0F0F0");
$graph->SetMarginColor("#F0F0F0");
$graph->legend->SetFont(FF_ARIAL, FS_NORMAL, 9);
$graph->legend->SetFillColor("white");
$graph->legend->SetLineSpacing(10);
$graph->legend->SetReverse(true);
$graph->SetAntiAliasing(true);

$plot = new PiePlot3D($ydata);
$plot->SetSize(0.5);
$plot->SetCenter(0.35, 0.55);
$plot->SetLegends($legend);
$plot->SetAngle(60);
$plot->Explode($explode);
$plot->SetStartAngle(90);
$plot->SetTheme("sand");
$plot->value->SetFont(FF_ARIAL, FS_NORMAL, 9);

// Add the plot to the graph
$graph->Add($plot);

// Display the graph
$graph->Stroke();
?>
