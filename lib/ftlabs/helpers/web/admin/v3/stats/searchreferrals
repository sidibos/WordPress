<?php
/*
########################################################
Stats page for search engine referrals

Upgraded to core v3 on 19th April 2006 by RB.

04/11/2004
Andrew Betts
Assanka Ltd
########################################################
*/

require_once("statslib");
if (!checkIfAuth("statistics", "", false, array("premium", "server"))) {
	outputPremiumGuideAndExit(&$page);
}

// Set up an array of search engine names
$enginenames = array("msn"=>"MSN Search", "search"=>"Unknown", "google"=>"Google", "aol"=>"AOL Search", "hotbot"=>"HotBot", "yahoo"=>"Yahoo Search", "askuk"=>"Ask.com UK", "google_image"=>"Google Image Search", "ask"=>"Ask.com", "altavista"=>"Altavista", "ukdirectory"=>"UK Directory", "lycos"=>"Lycos", "tiscali"=>"Tiscali", "dogpile"=>"DogPile", "alltheweb"=>"All the Web", "searchy"=>"Searchy", "netscape"=>"Netscape Search", "earthlink"=>"Earthlink", "mamma"=>"Mamma", "ukplus"=>"UK Plus", "atomz"=>"Atomz", "overture"=>"Overture", "dmoz"=>"Open Directory Project", "search.com"=>"Search.com", "seznam"=>"Seznam.cz", "aolde"=>"AOL Germany", "excite"=>"Excite Search", "ixquick"=>"ixQuick Metasearch", "webcrawler"=>"WebCrawler", "alexa"=>"Alexa", "metacrawler"=>"MetaCrawler", "infospace"=>"InfoSpace", "teoma"=>"Teoma", "go2net"=>"Go2Net");

// Create a new data table
$tb = new datatable("searchreferrals", "referral");

// Define columns
$tb->addColumn("engine", "Engine", "ASC");
$tb->addColumn("hits", "Hits", "DESC", $tb->RIGHTALIGN);
$tb->addColumn("hitspercent", "Percent of hits", "DESC", $tb->RIGHTALIGN);
$tb->addColumn("pages", "Pages", "DESC", $tb->RIGHTALIGN);
$tb->addColumn("pagespercent", "Percent of pages", "DESC", $tb->RIGHTALIGN);

// Define filters
$tb->addFilter("startdate", "Start month (mm/yyyy)", "partialtext", "s", false, date('m/Y'));
$tb->addFilter("enddate", "End month (mm/yyyy)", "partialtext", "e", false, date('m/Y'));

// Set default sort-by column
$tb->setSort("hits");

// Process the date filter
$startdate = Common::convertHumanTime($tb->getFilterValue("startdate"));
$enddate = Common::convertHumanTime($tb->getFilterValue("enddate"));
checkDateFilters(&$startdate, &$enddate, &$page);

$counts = getSearchEngines(date("mY", $startdate), date("mY", $enddate));

// Grab the totals
$totalhits = 0;
$totalpages = 0;
foreach ($counts as $data) {
	$totalhits += $data["hits"];
	$totalpages += $data["pages"];
}
if (!$totalhits) $totalhits = 1;
if (!$totalpages) $totalpages = 1;

// Deal with sorting the data...
sortArrayBasedTable(&$counts, &$tb);

foreach ($counts as $data) {
	if ($enginenames[$data["engine"]]) $data["engine"] = $enginenames[$data["engine"]];
	$data["hitspercent"] = number_format(($data["hits"]/$totalhits)*100, 1)."%";
	$data["hits"] = number_format($data["hits"]);
	$data["pagespercent"] = number_format(($data["pages"]/$totalpages)*100, 1)."%";
	$data["pages"] = number_format($data["pages"]);
	$tb->addRow($data, false);
}

// Build up the image string...
$graphString = "<img src=\"".$_SERVER["CORE_WEB_ALIAS"]."/admin/v3/stats/graphs/searchreferrals?start=".$startdate."&end=".$enddate.".\" style=\"width: 650px; height: 350px; margin-top: 10px;\" />";

// Construct the page
$page->addContent("content", "<div class=\"graphcont\">".$graphString."</div>");
$page->addContent("content", $tb->outputTable());
$page->addContent("context", $tb->outputFilterform());
$page->addContent("context", getStatsDateString($startdate, $enddate));
$page->addContent("context", file_get_contents("/assanka/web/admin/v3/stats/html/searchreferralsinfo"));

$page->render();
?>