
var FT=FT||{};FT.navigationAjax=(function(){var jsBaseUrl="http://navigation.webservices.ft.com/v1",headlinesBaseUrl="http://headlines.webservices.ft.com",navSourceDomain="navigation.webservices.ft.com";function supportsCors(){return'withCredentials'in new XMLHttpRequest();}
function supportsCrossDomain(){return((supportsCors()||typeof XDomainRequest!=="undefined")&&!FT.$('html').hasClass("msie7"));}
function jQueryAjax(config){FT.$.ajax({type:"GET",url:config.url,dataType:config.dataType,cache:true,success:config.onSuccess,error:config.onError,timeout:config.onTimeout});}
function XDR(config){var xdr=new XDomainRequest();xdr.open("get",config.url);xdr.onload=function(){var resp=xdr.responseText;if(typeof config.onSuccess==="function"){config.onSuccess(resp);}};xdr.onprogress=function(){};xdr.onerror=config.onError;xdr.ontimeout=config.onTimeout;setTimeout(function(){xdr.send();},0);}
function request(config){config.onError=function(){if(typeof config.error==="function"){config.error();}};config.onTimeout=function(){if(typeof config.timeout==="function"){config.timeout();}};config.onSuccess=function(data){if(data&&typeof config.success==="function"){config.success(data);}else{config.onError();}};if(supportsCors()){jQueryAjax(config);}else{if(config.dataType==="html"&&typeof XDomainRequest!=="undefined"){XDR(config);}else if(config.dataType==="json"){config.dataType="jsonp";jQueryAjax(config);}}}
function getNavigationHTML(dataSource,success){request({url:jsBaseUrl+"/navigation/ft/?format=html&level=second&api_key=dev&data="+dataSource,dataType:"html",success:success});}
function getHeadlinesJSON(uuid,success,error){request({url:headlinesBaseUrl+"/v1/headlines/"+uuid+"?source="+navSourceDomain,dataType:"json",success:success,error:error});}
return{supportsCrossDomain:supportsCrossDomain,getNavigationHTML:getNavigationHTML,getHeadlinesJSON:getHeadlinesJSON};}());var FT=FT||{};FT.navigation=(function(){var navEl,navWidth,firstLevelEls,headlinesTTL=300000,maxHeadlines=10,flyoutInView,timers={};function init(){navEl=FT.$("#nav-ftcom");firstLevelEls=navEl.find(".nav-item-l1");navWidth=navEl.width();function flyoutsLoaded(){prepareForHeadlines();listenForUserInput();}
if(FT.navigationAjax.supportsCrossDomain()){if(firstLevelEls.filter(".nav-has-flyout").size()===0){getFlyoutLevel2s(flyoutsLoaded);}else{flyoutsLoaded();}}}
function prepareForHeadlines(){firstLevelEls.filter("[data-headlinesuuid]").each(function(){var flyoutEl=FT.$(this).find(".nav-flyout");flyoutEl.addClass("nav-flyout-with-headlines");flyoutEl.append('<div class="nav-headlines"><h3 class="ft-heading ft-heading-medium">LATEST ARTICLES</h3><span class="nav-loading-state"></span><ul class="ft-list ft-list-bulletted"></ul></div>');});}
function getFlyoutLevel2s(success){var navSource=navEl.data("nav-source");if(typeof navSource==="string"&&navSource!==""){FT.navigationAjax.getNavigationHTML(navSource,function(data){injectFlyoutNavs(data);if(typeof success==="function"){success();}});}}
function injectFlyoutNavs(flyoutNavs){var firstLevelItems=navEl.find(".nav-item-l1"),secondLevelElems=FT.$(flyoutNavs);FT.$.each(firstLevelItems,function(idx){var secondLevelEl=secondLevelElems.filter("[data-navindex="+idx+"]");if(secondLevelEl.size()>0&&!FT.$(this).hasClass("nav-selected")){firstLevelItems.eq(idx).find(".nav-flyout").prepend(secondLevelEl);firstLevelItems.eq(idx).addClass("nav-has-flyout");}});}
function isWithinTTL(age){return(age<(new Date().getTime()-headlinesTTL));}
function limitArray(a,limit){return a.slice(0,limit);}
function listenForUserInput(){navEl.on("touchstart.nav",".nav-item-l1.nav-has-flyout > a",function(ev){var firstLevelEl=FT.$(ev.target).closest(".nav-item-l1");if(!firstLevelEl.hasClass("nav-show-flyout")){showSecondLevel(firstLevelEl);}else{hideSecondLevel(firstLevelEl);}
ev.preventDefault();});FT.$(document).on("touchstart.nav click.nav",function(ev){if(flyoutInView&&FT.$(ev.target).closest("#nav-ftcom").size()===0){hideSecondLevel(flyoutInView);}});navEl.on("touchstart.nav",".nav-has-l3",function(){if(flyoutInView){hideSecondLevel(flyoutInView);}
var li=FT.$(this);li.find("a").trigger("click");li.find("ol").remove();});navEl.on("mouseenter.nav",".nav-item-l1 > a",function(ev){showSecondLevel(FT.$(ev.target).closest(".nav-item-l1"));});navEl.on("mouseleave.nav",".nav-item-l1",function(ev){hideSecondLevel(FT.$(ev.target).closest(".nav-item-l1"));});FT.$(document).on("keydown.nav",".nav-item-l1.nav-has-flyout > a",function(ev){var firstLevelEl=FT.$(ev.target).closest(".nav-item-l1");if(ev.keyCode===40){showSecondLevel(firstLevelEl);}else if(ev.keyCode===38){hideSecondLevel(firstLevelEl);}});}
function hideSecondLevel(firstLevelEl){if(firstLevelEl){firstLevelEl.removeClass("nav-show-flyout");}else{navEl.find(".nav-items-l1 > .nav-show-flyout").removeClass("nav-show-flyout");}
flyoutInView=null;}
function showSecondLevel(firstLevelEl){if(!firstLevelEl.hasClass("nav-has-flyout")||firstLevelEl.hasClass("nav-show-flyout")){return;}
hideSecondLevel(flyoutInView);flyoutInView=firstLevelEl;checkHeadlines(firstLevelEl);positionFlyout(firstLevelEl);firstLevelEl.addClass("nav-show-flyout");}
function positionFlyout(firstLevelEl){var leftPos=firstLevelEl.position().left,flyoutWidth=firstLevelEl.find(".nav-flyout").width();if((leftPos+flyoutWidth)>navWidth){leftPos=navWidth-flyoutWidth;}else if(leftPos<0){leftPos=0;}
firstLevelEl.find('.nav-flyout').css({left:leftPos+"px"});}
function checkHeadlines(firstLevelEl){var uuid=firstLevelEl.data("headlinesuuid"),age=firstLevelEl.data("headlinesage")||0,flyoutEl=firstLevelEl.find(".nav-flyout");if(!uuid&&flyoutEl.find(".nav-headlines .ft-list-item").size()===0){flyoutEl.find(".nav-headlines").remove();flyoutEl.removeClass("nav-flyout-with-headlines");}else if(uuid&&isWithinTTL(age)&&!flyoutEl.hasClass("nav-loading")){getHeadlines(firstLevelEl,uuid);}}
function getHeadlines(firstLevelEl,uuid){var flyoutEl=firstLevelEl.find(".nav-flyout");flyoutEl.addClass("nav-loading");var topLevelText=encodeURIComponent(firstLevelEl.children("a").text().replace(/\s+/g,""));timers[topLevelText]=new Date().getTime();FT.navigationAjax.getHeadlinesJSON(uuid,function(data){if(data&&data.length&&data[0].headlines){var ts=new Date().getTime();firstLevelEl.data("headlinesage",ts);renderHeadlines(flyoutEl,limitArray(data[0].headlines,maxHeadlines));if(timers[topLevelText]){sendTracking(topLevelText,(ts-timers[topLevelText]));delete timers[topLevelText];}}
flyoutEl.removeClass("nav-loading");},function(){firstLevelEl.removeData("headlinesuuid").removeAttr("data-headlinesuuid");sendTracking(topLevelText,"fail");flyoutEl.removeClass("nav-loading");});}
function sendTracking(tl,data){if(FT&&FT.analytics&&FT.analytics.siteIntelligence){FT.analytics.siteIntelligence.sendAdditionalTracer("/eventonpage","type=nav.headlineload."+tl+"&data="+data);}}
function renderHeadlines(flyoutEl,headlines){var headlinesListEl=flyoutEl.find(".nav-headlines .ft-list"),headlinesHTML=[];headlinesListEl.empty();FT.$.each(headlines,function(i,v){headlinesHTML.push('<li class="ft-list-item"><a href="'+v.url+'" class="ft-link-stealth">'+v.headline+'</a></li>');});headlinesListEl.append(headlinesHTML.join(''));}
function showRSSLink(url){if(typeof url==="string"&&url!==""){var rssEl=navEl.find(".nav-rss");if(rssEl.find("a").size()===0){rssEl.wrapInner('<a></a>');}
rssEl.find("a").attr("href",url);rssEl.show();}}
return{init:function(){init();showRSSLink(FT.$('link[type="application/rss+xml"]').attr("href"));},destroy:function(){navEl.off(".nav");FT.$(document.body).off(".nav");}};}());FT.navigation.init();