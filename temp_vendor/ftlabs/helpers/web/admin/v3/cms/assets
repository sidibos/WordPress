<?php
/**
 * CMS assets page - displays all assets in the system.
 *
 * Accepted Inputs: none
 *
 * @copyright The Financial Times Limited [All Rights Reserved]
 */

require_once($_SERVER["DOCUMENT_ROOT"]."/lib/inc/global");
require_once("cmslib");

$authuser = ($_SERVER["PHP_AUTH_USER"])?$_SERVER["PHP_AUTH_USER"]:$_SERVER["REMOTE_USER"];

// Config **todo** - get and set the language
$languageisocode = "en";
$formats = $db->query("SELECT dateformat, timeformat FROM out_languages WHERE isocode='".$languageisocode."'");
$formatsrow = $db->fetchrow($formats);
$dateFormat = $formatsrow["dateformat"];
$timeFormat = $formatsrow["timeformat"];

$page->addContent("content", "<div id=\"oltree\">");

// Add some common javascript to the page
$page->addContent("content", "<script type=\"text/javascript\" src=\"".$_SERVER["CORE_WEB_ALIAS"]."/admin/v3/js/outline\"></script>");
$page->addContent("content", "<script type=\"text/javascript\">");
$page->addContent("content", "var oltree = new OutlineTreeView('".((isset($_SESSION["outlinehostname"]) && $_SESSION["outlinehostname"])?$_SESSION["outlinehostname"]:$_SERVER['HTTP_HOST'])."', '".$webroot."', ".((cmsIsFunctionalityEnabled("versionhistory"))?"true":"false").", 'asset'); oltree.adddocumenthandler();");
$page->addContent("content", "</script>");

// Import some CSS
$page->addContent("content", "<style type=\"text/css\">@import url(\"".$_SERVER["CORE_WEB_ALIAS"]."/admin/v3/css/outline\");</style>");

// Pull out all assets in the database, including all drafts if any
$result = $db->query("SELECT out_items.id as itemid, out_localcontent.id as contentid, out_versions.id AS versionid, title, DATE_FORMAT(datecreated, '".$dateFormat." ".$timeFormat."') as datecreated, authoruser, draftuser, cfg_adminusers.name AS author, tag, visibility FROM out_items LEFT JOIN out_localcontent ON out_items.id = out_localcontent.itemid LEFT JOIN out_versions ON out_localcontent.id = out_versions.localcontentid LEFT JOIN cfg_adminusers ON out_versions.authoruser=cfg_adminusers.htaccessuser WHERE type='asset' AND (islive=1 OR draftuser IS NOT NULL) AND languageisocode='".$languageisocode."' ORDER BY draftuser IS NULL DESC, sortindex, IF(draftuser IS NULL, title, draftuser!='".$db->sqlenc($_SESSION["outlineadmin"])."') ASC, datecreated ASC");

// Set up a variable to store asset rows, for grouping of live and drafts, before outputting at end
$rowsarray = array();

// Step through the assets
while ($row = $db->fetchrow($result)) {
	$islive = $isdeleteable = $iseditable = (($row["draftuser"] == "")?true:false);

	// If this row doesn't already exist in the row array, create an entry for it
	if (!$rowsarray[$row["contentid"]]) {
	
		$rowsarray[$row["contentid"]] = array("contentid"=>$row["contentid"], "title"=>$row["title"], "tag"=>$row["tag"], "author"=>$row["author"], "datecreated"=>$row["datecreated"], "iseditable"=>$iseditable, "isdeleteable"=>$isdeleteable, "islive"=>$islive, "visibility"=>$row["visibility"], "drafthtml"=>"", "firstversionid"=>$row["versionid"]);
	}
	
	// Append a draft record to the row output if this row is a draft
	if ($row["draftuser"]) $rowsarray[$row["contentid"]]["drafthtml"] .= getDraftHTML($rowsarray[$row["contentid"]]["firstversionid"], $row["versionid"], $row["draftuser"], $row["authoruser"], $row["author"], true);
}

// Loop through the asset array and output each row
foreach ($rowsarray as $row) {

	// Outline extension: allow changes to be made to
	// the asset before  outputting the tree view row
	$extendarray = array(&$row);
	extendCMS("assetIndexEditRow", $extendarray);

	$rowhtml = getTreeViewRow($row["contentid"], $row["title"], $row["tag"], $row["author"], $row["datecreated"], $row["iseditable"], false, false, false, $row["isdeleteable"], $row["islive"], $row["visibility"], $row["drafthtml"], false, true);
	$page->addContent("content", $rowhtml);
}

$page->addContent("content", "</div>");


// Add actions and content to the sidebar
$page->addContent("context", $page->loadExternalContent("html/indexsidebar"));
$page->addAction("add", "Add Asset", "assetnew");
$page->addAction("edit", "Edit Asset", "edit", false, false, true);
$page->addAction("sort", "Sort Subsections", "sort", false, false, true);
$page->addAction("history", "Asset History", "viewhistory", false, false, true);
$page->addAction("delete", "Delete", false, "oltree.submitfordelete()", false, true);

$page->render();
?>