<?php
/**
 * CMS diff page - displays a textual comparison of two revisions of
 * pages or assets, as well as a full preview of each version.
 *
 *  Accepted Inputs: (_REQUEST) fileforcomp1: version to make the
 * comparison from. (_REQUEST) fileforcomp2: version to make the
 * comparison to. (_REQUEST) fileforcompspecial: May contain values
 * indicating comparison to live/previous versions of the page.
 *
 * @copyright The Financial Times Limited [All Rights Reserved]
 */
require_once($_SERVER["DOCUMENT_ROOT"]."/lib/inc/global");
require_once($_SERVER["CORE_PATH"]."/web/common/v1/formatteddifference");
require_once("cmslib");

// Config **todo** - get and set the site and language
$languageisocode = "en";
$formats = $db->query("SELECT dateformat, timeformat FROM out_languages WHERE isocode='".$languageisocode."'");
$formatsrow = $db->fetchrow($formats);
$dateFormat = $formatsrow["dateformat"];
$timeFormat = $formatsrow["timeformat"];

// Error if this project does not have version control enabled
if (!cmsIsFunctionalityEnabled("versiondiff")) trigger_error(APPNAME." does not have the correct permissions to use version control.", E_USER_ERROR);

// Validate the versions being compared - initially the first version id
if (!is_numeric($_REQUEST["fileforcomp1"])) trigger_error("Expected variable id not supplied or non numeric", E_USER_ERROR);

// Now the second version id or special instruction
if (!in_array($_REQUEST["fileforcomp2special"], array("previous", "live")) && (!is_numeric($_REQUEST["fileforcomp2"]))) trigger_error("Expected variable id not supplied or non numeric", E_USER_ERROR);


$sqlString = "SELECT v.id, v.localcontentid, title, html, datecreated, DATE_FORMAT(datecreated, '".$dateFormat." ".$timeFormat."') as modifiedlong, a.name as author, draftuser, islive FROM out_versions v LEFT JOIN cfg_adminusers a ON v.authoruser=a.htaccessuser WHERE ";

// Select the first revision to compare, using the numeric id provided
$revisionone = $db->queryRow($sqlString." v.id=".$_REQUEST["fileforcomp1"]);
if (!$revisionone) trigger_error("Revision one not found", E_USER_ERROR);


// Select the second revision to compare to, which can be either the live version, the version prior to the first, or a numeric id
if ($_REQUEST["fileforcomp2special"] == "previous") {
	$revisiontwo = $db->queryRow($sqlString." v.localcontentid=".$revisionone["localcontentid"]." AND datecreated<'".$db->sqlenc($revisionone["datecreated"])."' ORDER BY datecreated DESC LIMIT 1");
} else if ($_REQUEST["fileforcomp2special"] == "live") {
	$revisiontwo = $db->queryRow($sqlString." v.localcontentid=".$revisionone["localcontentid"]." AND islive=1");
} else {
	$revisiontwo = $db->queryRow($sqlString." v.id='".$db->sqlenc($_REQUEST["fileforcomp2"])."'");
}
if (!$revisiontwo) trigger_error("Record two not found", E_USER_ERROR);


// For presentation purposes, ensure the chronologically earlier revision is always displayed on the left
if ($revisionone["datecreated"] > $revisiontwo["datecreated"]) {
	$revswap = $revisionone;
	$revisionone = $revisiontwo;
	$revisiontwo = $revswap;
}

$page->addContent("content", "<h4 style=\"margin-top: 0px;\">Textual Revision Comparison</h4>");

// Prepare the diff data, and use the getDifference function to display a formatted diff table
$titleOne = "<strong>".$revisionone["title"]."<br />".(($revisionone["draftuser"])?"Draft":"Revision")." as of ".$revisionone["modifiedlong"]."</strong><br />Author: ".$revisionone["author"].(($revisionone["islive"])?"<br /><strong>Live Revision</strong>":"").(($revisionone["draftuser"])?"<br /><strong>draft</strong>":"");
$titleTwo = "<strong>".$revisiontwo["title"]."<br />".(($revisiontwo["draftuser"])?"Draft":"Revision")." as of ".$revisiontwo["modifiedlong"]."</strong><br />Author: ".$revisiontwo["author"].(($row2["islive"])?"<br /><strong>Live Revision</strong>":"").(($revisiontwo["draftuser"])?"<br /><strong>Draft</strong>":"");
$page->addContent("content", getDifference($revisionone["html"], $revisiontwo["html"], $titleOne, $titleTwo));
if ($revisionone["html"] == $revisiontwo["html"]) $page->addContent("content", "<br /><em style=\"width: 100%; text-align: center; display: block;\">There are no differences between the two selected revisions</em>");

// Display the two preview panes and buttons to switch between them; set up
// the content and use an external file as a template.
$diffcontent = array("--revision1title--"=>(($revisionone["islive"])?"Live Revision, created on ":(($revisionone["draftuser"])?"Draft as of ":"Revision as of ")).$revisionone["modifiedlong"],
	"--revision2title--"=>(($revisiontwo["islive"])?"Live Revision, created on ":(($revisiontwo["draftuser"])?"Draft as of ":"Revision as of ")).$revisiontwo["modifiedlong"],
	"--revision1id--"=>$revisionone["id"],
	"--revision2id--"=>$revisiontwo["id"]);

$page->addContent("content", str_replace(array_keys($diffcontent), array_values($diffcontent),$page->loadExternalContent("html/historydiffview")));


$page->alert("The differences between the two revisions you have selected are displayed in two different formats:<br /> &bull; At the top of the page is a comparison of all the differences, highlighting changes and showing lines added or removed.<br /> &bull; At the bottom of the page is a pane showing the most recent version selected, with buttons allowing you to change between the two versions.");
$page->render();
exit;

// Display buttons to allow selection of which preview to show, done with javascript and showing/hiding divs
?>
<br />
</td>
<?php
htm_footer();
?>