<?php
/**
 * An custom version of XapianEnquire which allows multiple retries of queries on failure
 *
 * @codingstandard ftlabs-phpcs
 * @copyright The Financial Times Limited [All Rights Reserved]
 */
class XapianEnquireAssanka extends XapianEnquire {
	function get_mset($first,$maxitems,$checkatleast_or_omrset=null,$omrset_or_mdecider=null,$mdecider=null,$matchspy=null) {
		$ii = 0;
		while (true) {
			try {
				return call_user_func_array(array($this, 'parent::get_mset'), func_get_args());
			} catch (Exception $e) {

				// If exception is thrown try again, up to three times.
				if (++$ii >= 3) {

					// After three failed attempts, just return no results
					return new XapianMSet();
				}

				// Sleep using a backoff algorithm
				sleep($ii);
			}
		}
	}
}