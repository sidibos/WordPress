<?php

// REVIEW:RB:20071119: I've made a sanity pass through this file, along with v3/fileuploader, to clean
// up logic dead-ends and fix browser anomalies, and tested with FF/IE6/IE7/Saf2/Saf3.  However the code
// still feels clunky and I feel could benefit from a rewrite come the next version of the core.  The
// removing-iframe behaviour appears to work but seems to leave odd vestiges in IE/Saf, causing intermittent
// weird behviour wrt error messages and the like.

if (empty($jsdirectaccess)) {
	header("Cache-Control: must-revalidate");
	header("Content-type: text/javascript");
	$offset = 60 * 60 * 24 * 3;
	header("Expires: " . gmdate("D, d M Y H:i:s", time() + $offset) . " GMT");
}
?>

function FileUploader() {
	FileUploader.frmupload = false;
	FileUploader.iframe = false;
	FileUploader.sourcefield = false;
	FileUploader.fileuploaded = false;
}
FileUploader.fileupload = function (ele, path) {
	if (!path) path = "";
	txtfilename = ele;
	for (var i=0; txtfilename && txtfilename.type != "text" && txtfilename.type != "hidden" && i<10; i++) {
		txtfilename = txtfilename.previousSibling;
	}
	if (!txtfilename || !(txtfilename.type == "text" || txtfilename.type == "hidden")) {
		alert("Upload error: Cannot select filename field");
		return false;
	}
	var mybody=document.getElementsByTagName("body").item(0);
	if (FileUploader.frmupload) {
		//FileUploader.frmupload.innerHTML = "";
		mybody.removeChild(FileUploader.frmupload);
	}

	var html = "<div id=\"uplhead\"><iframe name=\"uplframename\" id=\"uplframe\" class=\"uploadframe\" src=\"<?=$_SERVER["CORE_WEB_ALIAS"]?>/admin/v3/html/blank\"></iframe></div><form target=\"uplframename\" action=\"<?=$_SERVER["CORE_WEB_ALIAS"]?>/admin/v3/fileuploader\" method=\"post\" enctype=\"multipart/form-data\"><div id=\"uplinfo\"><p style=\"margin: 0px 10px\"><span class=\"hiddentext\">Upload file</span><img src=\"<?=$_SERVER["CORE_WEB_ALIAS"]?>/admin/v3/waitmsg/msg_uploadfiles.png\" height=\"17\" /></p>";
	html += "<div class=\"tabrow\" style=\"margin: 15px 0 0 0; width: 100%; height: 19px;\"><ul style=\"margin: 0 0 0 5px; float: left;\"><li class=\"current\"><div><a href=\"javascript:FileUploader.togglesource(1)\">from&nbsp;my&nbsp;computer</a></div></li><li><div><a href=\"javascript:FileUploader.togglesource(2)\">from&nbsp;another&nbsp;website</a></div></li></ul></div>";
	if (txtfilename.value) {
		html += "<input type=\"hidden\" name=\"existingfile\" value=\""+txtfilename.value+"\" style=\"display: none;\" />";
	}
	if (path.length) {
		html += "<input type=\"hidden\" name=\"path\" value=\""+path+"\" style=\"display: none;\" />";
	}
	html += "<div class=\"dialogcontent\" id=\"uplmode1\"><p>Click the browse button to select a file from your computer or network</p><input type=\"file\" name=\"newfile\"><input type=\"button\" value=\"Upload\" onclick=\"FileUploader.startUpload()\"></div>";
	html += "<div class=\"dialogcontent\" id=\"uplmode2\" style=\"display: none\"><p>Type or paste the full internet URL at which the file can be found</p><input type=\"text\" name=\"url\" style=\"width: 200px\" value=\"http://\"><input type=\"button\" value=\"Upload\" onclick=\"FileUploader.startUpload()\"></div>";
	html += "</div></form><div id=\"uplfoot\"><a href=\"javascript:FileUploader.cancelUpload()\">Click to cancel</a></div>";
	
	FileUploader.iframediv = document.createElement("iframe");
	FileUploader.iframediv.className = "uploadiframe";
	mybody.appendChild(FileUploader.iframediv);
	if (FileUploader.iframediv.contentDocument) {
		iframedoc = FileUploader.iframediv.contentDocument; 
	} else if (FileUploader.iframediv.contentWindow) {
		iframedoc = FileUploader.iframediv.contentWindow.document;
	} else if (FileUploader.iframediv.document) {
		iframedoc = FileUploader.iframediv.document;
	}
 	iframedoc.location.replace('<?=$_SERVER["CORE_WEB_ALIAS"]?>/admin/v3/html/blank');
	FileUploader.iframediv.style.height = (mybody.offsetHeight+mybody.style.marginTop+mybody.style.marginBottom)+"px";
	FileUploader.backgrounddiv = document.createElement("DIV");
	FileUploader.backgrounddiv.className = "uploadformbg";
	mybody.appendChild(FileUploader.backgrounddiv);
	backgroundheight = mybody.offsetHeight+mybody.style.marginTop+mybody.style.marginBottom;
	if (window.innerHeight && (window.innerHeight > backgroundheight)) backgroundheight = window.innerHeight;
	FileUploader.backgrounddiv.style.height = backgroundheight+"px";
	FileUploader.frmupload = document.createElement("DIV");
	FileUploader.frmupload.className = "uploadform";
	FileUploader.frmupload.innerHTML = html;
	FileUploader.iframe = document.getElementById("uplframe");
	mybody.appendChild(FileUploader.frmupload);
	FileUploader.sourcefield = txtfilename;
	if( typeof( window.innerWidth ) == 'number' ) { // Non-IE
		windowheight = window.innerHeight;
		windowscrolly = window.pageYOffset;
	} else if (document.documentElement && (document.documentElement.clientWidth || document.documentElement.clientHeight)) { // IE 6+, standards mode
		windowheight = document.documentElement.clientHeight;
		windowscrolly = document.documentElement.scrollTop;
	} else if (document.body && (document.body.clientWidth || document.body.clientHeight)) { //IE 4 compatible
		windowheight = document.body.clientHeight;
		windowscrolly = document.body.scrollTop;
	} else {
		windowheight = 450;
		windowscrolly = 0;
	}
	FileUploader.frmupload.style.top = (windowscrolly + ((windowheight - FileUploader.frmupload.offsetHeight)/2))+'px';
}

FileUploader.startUpload = function () {
	if (FileUploader.frmupload) {
		var frm = FileUploader.frmupload.getElementsByTagName("FORM")[0];
		frm.submit();
		var infodiv = obj("uplinfo");
		infodiv.innerHTML = "<p style=\"margin: 0px 10px\"><img src=\"<?=$_SERVER["CORE_WEB_ALIAS"]?>/admin/v3/waitmsg/msg_uploading.png\" height=\"17\" /></p>";
		infodiv.innerHTML += "<p style=\"margin: 14px 10px 0px 10px\"><img src=\"<?=$_SERVER["CORE_WEB_ALIAS"]?>/admin/v3/waitmsg/loading.gif\" width=\"78\" height=\"7\" /></p>";
		FileUploader.fileuploaded = true;
	}
}

FileUploader.uploadComplete = function (fname) {
	if (FileUploader.sourcefield) {
		FileUploader.sourcefield.value = fname;
		if (FileUploader.sourcefield.nextSibling && FileUploader.sourcefield.nextSibling.className) {
			if (FileUploader.sourcefield.nextSibling.className.indexOf("imageupload") != -1 || FileUploader.sourcefield.nextSibling.className.indexOf("fupload") != -1) {
				FileUploader.sourcefield.nextSibling.innerHTML = fname;
			}
		}
	}
	setTimeout(FileUploader.removeUploadHTML, 50);
}
FileUploader.cancelUpload = function () {
	setTimeout(FileUploader.removeUploadHTML, 50);
}
FileUploader.uploadError = function (msg) {
	if (FileUploader.fileuploaded) { // Cached iframe/refresh workaround
		alert(msg);
		setTimeout(FileUploader.removeUploadHTML, 50);
	}
}
FileUploader.removeUploadHTML = function() {
	if (FileUploader.frmupload) {
		var mybody=document.getElementsByTagName("body").item(0);
		FileUploader.frmupload.parentNode.removeChild(FileUploader.frmupload);
		FileUploader.iframediv.parentNode.removeChild(FileUploader.iframediv);
		FileUploader.backgrounddiv.parentNode.removeChild(FileUploader.backgrounddiv);
		FileUploader.frmupload = false;
		FileUploader.fileuploaded = false;
	}
}
FileUploader.togglesource = function (sid) {
	if (FileUploader.frmupload) {
		if (sid==1) {
			var oid = 2;
		} else {
			var oid = 1;
		}
		var infobox = obj("uplinfo");
		var lis = infobox.getElementsByTagName("li");
		for (var i=0; i<lis.length; i++) {
			if (i==(sid-1)) {
				lis[i].className="current";
			} else {
				lis[i].className="";
			}
			lis[i].blur();
		}
		obj("uplmode"+sid).style.display = "block";
		obj("uplmode"+oid).style.display = "none";
	}
}
