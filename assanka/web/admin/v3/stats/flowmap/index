<?php
/*
########################################################
Index page for flow maps

05/12/2004
Andrew Betts
Assanka Ltd
########################################################
*/

require_once("statsliblink");
if (!checkIfAuth("statistics", "", false, array("premium", "server"))) {
	outputPremiumGuideAndExit(&$page);
}

// Check for the stats folder and create if not present
if (!file_exists($_SERVER["DOCUMENT_ROOT"]."/lib/tmp/stats")) {
	$old_umask = umask(0);
	mkdir($_SERVER["DOCUMENT_ROOT"]."/lib/tmp/stats", 0777);
	umask($old_umask);
}

// Trigger flowmap generation if necessary
startFlowMapGenerator();

// Create a new data table to show stored and queued flowmaps
$tb = new datatable("flowmaps", "traffic flow map");

// Define columns
$tb->addColumn("start", "Start month", "ASC");
$tb->addColumn("end", "End month", "ASC");
$tb->addColumn("generated", "Generated", "DESC");
$tb->addColumn("paths", "Paths", "DESC");
$tb->addColumn("status", "", "ASC", false, 100);
$tb->addColumn("dellink", "", "ASC", false, 100);

// Set default sort-by column
$tb->setSort("generated");

// Get all the flow maps for this project
$flowmaps = getFlowmaps();

// Grab a count of the numbers of pages left before pagination, and page count
$numresults = count($flowmaps);
$numpages = ceil($numresults/$tb->rowsperpage);

// Deal with sorting the data...
sortArrayBasedTable(&$flowmaps, &$tb);

// Define page number, default to page 1
$pno = (!empty($_GET["p"]) and is_numeric($_GET["p"])) ? $_GET["p"] : 1;

// Paginate the pages list (!)
if ($numresults > $tb->rpp) {
	$flowmaps = array_slice($flowmaps, (($pno * $tb->rowsperpage) - $tb->rowsperpage), $tb->rowsperpage);
}

// Format the data
foreach ($flowmaps as $data) {
	$data["start"] = $data["startlong"];
	$data["end"] = $data["endlong"];
	$data["generated"] = $data["generatedlong"];
	if ($data["complete"]) $data["status"] = "<a href=\"view?file=".$data["filename"]."\">View Flow Map</a>";
	else $data["status"] = "<div id=\"".$data["filename"]."bar\" class=\"pbar\"><div id=\"".$data["filename"]."prog\">&nbsp;</div></div><span id=\"".$data["filename"]."info\" class=\"pinfo\">Queued</span>";
	$data["dellink"] = "<a href=\"delete?file=".$data["filename"]."\">Delete</a>";
	$tb->addRow($data, false);
}

// Construct the page
$page->addContent("content", $tb->outputTable());
$page->addContent("context", $db->outputPagination($numresults, $numpages, $pno, "flowmap"));
$page->addContent("context", $page->loadExternalContent("html/flowmapinfo"));

// Add action buttons
$page->addAction("new", "New Flow Map", "new");

$page->title = "Statistics - Traffic Flow Maps";
$page->render();
?>
