<?php
require_once("../appglobal");



// This file is deprecated, and should no longer be in use.  This error designed to catch cases where it is still being used.
trigger_error('Deprecated code in use', E_USER_DEPRECATED);





if (!empty($_REQUEST["id"])) {
	$kb = $sdb->queryRow("SELECT *, CONCAT(client,'-',project) as clientproject FROM knowledge WHERE {id}", $_REQUEST);
} 

// Check permissions for this knowledge item, if in edit mode
if (!empty($kb)) {
	$isdeveloper = $sdb->querySingle("SELECT isdeveloper FROM permissions WHERE userid=".$_SESSION["support"]["userid"]." AND ((client='".$kb["client"]."' AND project='".$kb["project"]."') OR (client='".$kb["client"]."' AND project IS NULL) OR (client IS NULL AND project IS NULL)) ORDER BY (project IS NOT NULL AND client IS NOT NULL) DESC, (client IS NOT NULL) DESC LIMIT 1");
	if (!$isdeveloper) {
		$page->redirectAndAlert("You may not create or edit knowledge items, as you are not a developer", "error", "knowledge/");
	}
} else {
	if (!$sdb->querySingle("SELECT COUNT(*) FROM permissions WHERE userid=".$_SESSION["support"]["userid"]." AND isdeveloper=1")) {
		$page->redirectAndAlert("You may not create or edit knowledge items, as you are not a developer", "error", "knowledge/");
	}
}

// Ensure permissions are set up for FCKEditor file use
knowledgeBaseCheckPermissions();

$frm = new inputform("kb");
$grp = new simplefieldgroup($frm);
$grp->addField("id", Model::$fields["id"]);
$grp->addField("title", Model::$fields["kbtitle"]);
$grp->addField("supportrequestid", Model::$fields["kbreqid"]);
$grp->addField("clientproject", Model::$fields["kbclientproject"]);

// File upload field if libCURL on this server
if (function_exists("curl_init")) {
	if (!empty($kb["filename"])) Model::$fields["filename"]["existingfile"] = $kb["filename"];
	$grp->addField("filename",Model::$fields["filename"]);
}

// FCK editor field
$grp->addField("textcontent", Model::$fields["kbtext"]);

// Check for submitted information, move uploaded files to permanent location, and validate data
if ($_POST) {
	$grp->addData($_POST);
	$data = $grp->getSubmittedData();
	
	if (is_numeric($data["supportrequestid"])) {
		if (!$sdb->querySingle("SELECT COUNT(*) FROM requests WHERE id={supportrequestid|nokey}", $_POST)) {
			$grp->makeInputInvalid("supportrequestid","Support request ID not found");
		}
	} else {
		$data["supportrequestid"] = "null";
	}

	if ($grp->checkValidity()) {

		if (!empty($data["filename"])) {

			// Detect just-uploaded file by whether or not it can be found on the server
			if (file_exists($data["filename"])) {
				$uploadedfilenewname = moveFileToNewServer($data["filename"]);
			}
		}

		// Prepare data for submission to database
		$data["client"] = $data["project"] = "null";
		if (!empty($data["clientproject"])) {
			if (isset($data["clientproject"]{5})) {
				list($data["client"], $data["project"]) = explode("-", $data["clientproject"], 2);
			} else {
				$data["client"] = $data["clientproject"];
			}
		}

		// Update or insert into database
		$xtraqry = (!empty($uploadedfilenewname)) ? ", filename='".$sdb->sqlenc($uploadedfilenewname)."'" : "";
		if (!empty($kb)) {
			$sdb->query("UPDATE knowledge SET {title}, {supportrequestid}, modified=NOW(), {client}, {project}, {textcontent}".$xtraqry." WHERE {id}", $data);
			$page->alert("Item successfully amended", "done");
		} else {
			$sdb->query("INSERT INTO knowledge SET {title}, {supportrequestid}, modified=NOW(), {client}, {project}, {textcontent}, userid=".$_SESSION["support"]["userid"].", author='".$sdb->sqlenc($_SESSION["support"]["username"])."'".$xtraqry, $data);
			$page->alert("Item successfully created", "done");
			$newknowledgeid = $sdb->getInsertid();
		}

		$page->redirect("knowledge/view?id=".((empty($kb)?$newknowledgeid:$kb["id"])));
	
	// If input is invalid, redisplay...
	} else {
		
		// Add an error infobar message
		$page->alert("There was a problem with the data you submitted.  Please review the help text to the right of the form fields, or mouseover the fieldnames highlighted in red for an explanation.", "error");
	}
} else {

	// Load existing values if in edit mode
	if (!empty($kb)) {
		$grp->addData($kb);

		// Define an informational infobar message
		$page->alert("When you have finished editing this item, click the Save button to the right");	
	} else {

		// Define an informational infobar message
		$page->alert("When you have finished creating the item, click the Save button to the right");
	}
}

$page->addAction("Save", array("javascript"=>"document.frmkb.submit()"));
$page->addAction("Cancel", 	((empty($kb)) ? "index" : "requests/view?id=".$kb["id"]));

// Output the form and help panel to the page
$page->add($frm->getOutput());
$page->set("title", "Create/edit a knowledge item");
$page->outputHTML();
?>