<?php
/*
########################################################
feeds

Provides an RSS feed in 2.0 format.

Accepted Inputs:
none

06/06/2006
Andrew Betts
Assanka Ltd
########################################################
*/

require_once("appglobal");




// This file is deprecated, and should no longer be in use.  This error designed to catch cases where it is still being used.
trigger_error('Deprecated code in use', E_USER_DEPRECATED);



$params = Common::getUrlParams();
if (!isset($params[0])) exit("No parameters specified");
$params = explode(":", base64_decode(urldecode($params[0])));
if (sizeof($params) != 3) exit("Incorrect parameters");
list($mode,$userid,$itemid) = $params;

$baseuri = preg_replace("/\/feeds\/?$/i", "", $_SERVER["SCRIPT_NAME"]);

$modes=array("new", "mine", "item");
if (!isset($modes[$mode])) exit("Invalid feed mode");
if (!is_numeric($userid)) exit("Invalid userid");
if (!is_numeric($itemid)) exit("Invalid itemid");

$username = $sdb->querySingle("SELECT displayname FROM users WHERE id=".$userid);
$mode = $modes[$mode];

if ($mode != "item") {
	$qry = "SELECT DISTINCT r.id, r.title, u2.displayname AS author, r.client, r.project, u1.displayname AS assignedto, r.description, UNIX_TIMESTAMP(r.datemodified) as datemodified, r.status, IF(classification IS NULL, 'unclassified', classification) as classification, charge, importance FROM permissions p
	LEFT JOIN requests r ON (p.client=r.client AND (p.project=r.project OR p.project IS NULL)) OR p.client IS NULL
	LEFT JOIN users u1 ON (r.assignedtouserid = u1.id)
	LEFT JOIN users u2 ON (r.authoruserid = u2.id)";
	if ($mode=="new") {
		$qryWhere = "WHERE p.userid='".$userid."' AND r.id IS NOT NULL AND status='new' AND authoruserid<>".$userid;
		$title = "New Support Requests";
	} else {
		$qryWhere = "WHERE p.userid='".$userid."' AND r.id IS NOT NULL AND (assignedtouserid=".$userid." OR authoruserid=".$userid.")";
		$title = "My Support Requests";
	}
	$qryWhere .= " AND status IN ('new','assigned') AND IF(classification IS NULL,'unclassified',classification) NOT IN ('OBS','CFGC')";
	$sdb->query($qry." ".$qryWhere . " GROUP BY r.id");

	// Output headers
	header("Content-type: text/xml");
	echo "<"."?xml version=\"1.0\" encoding=\"ISO-8859-1\" ?".">\n";
	?>
	<rss version="2.0">
	<channel>
		<title><?=$title?></title>
		<description>Support request feed from Assanka</description>
		<language>en-gb</language>
		<lastBuildDate><?=date("r")?></lastBuildDate>
		<ttl>15</ttl>
		<link>http://<?=$_SERVER["HTTP_HOST"]?></link>
		<?php
		while ($row = $sdb->getRow()) {
			?>
			<item>
				<title><![CDATA[<?=$row["title"]?>]]></title>
				<description><![CDATA[<?=$row["description"]?>]]></description>
				<link><![CDATA[http://<?=$_SERVER["HTTP_HOST"]?><?=$baseuri?>/requests/view?id=<?=$row["id"]?>]]></link>
				<guid isPermaLink="false"><?=$row["id"]?></guid>
				<pubDate><?=date("r", $row["datemodified"])?></pubDate>
			</item>
			<?php
		}
		?>
	</channel>
	</rss>
	<?php
} else {

	$sdb->query("SELECT r.id, r.title, u2.displayname AS author, r.client, r.project, u1.displayname AS assignedto, r.description, UNIX_TIMESTAMP(r.datemodified) as datemodified, r.status, IF(classification IS NULL, 'unclassified', classification) as classification, charge, importance FROM permissions p
	LEFT JOIN requests r ON (p.client=r.client AND (p.project=r.project OR p.project IS NULL)) OR p.client IS NULL
	LEFT JOIN users u1 ON (r.assignedtouserid = u1.id)
	LEFT JOIN users u2 ON (r.authoruserid = u2.id)
	WHERE p.userid='".$userid."' AND r.id=".$itemid."
	GROUP BY r.id");
	if (!$sdb->getNumResults()) exit("Request not found or access denied");
	$request = $sdb->getRow();

	// Check developer status
	$isdeveloper = $sdb->querySingle("SELECT isdeveloper FROM permissions WHERE userid=".$userid." AND ((client='".$request["client"]."' AND project='".$request["project"]."') OR (client='".$request["client"]."' AND project IS NULL) OR (client IS NULL AND project IS NULL)) ORDER BY (project IS NOT NULL AND client IS NOT NULL) DESC, (client IS NOT NULL) DESC LIMIT 1");

	// Output headers
	header("Content-type: text/xml");
	echo "<"."?xml version=\"1.0\" encoding=\"ISO-8859-1\" ?".">\n";
	?>
	<rss version="2.0">
	<channel>
		<title><![CDATA[<?=$request["title"]?> - support request updates from Assanka]]></title>
		<description>Support request feed from Assanka</description>
		<language>en-gb</language>
		<lastBuildDate><?=date("r")?></lastBuildDate>
		<ttl>15</ttl>
		<link><![CDATA[http://<?=$_SERVER["HTTP_HOST"]?><?=$baseuri?>/requests/view?id=<?=$request["id"]?>]]></link>
		<item>
			<title><![CDATA[<?=$request["title"]?>]]></title>
			<description><![CDATA[<?=$request["description"]?>]]></description>
			<link><![CDATA[http://<?=$_SERVER["HTTP_HOST"]?><?=$baseuri?>/requests/view?id=<?=$request["id"]?>]]></link>
			<guid isPermaLink="false"><?=$request["id"]?></guid>
			<pubDate><?=date("r", $request["datemodified"])?></pubDate>
		</item>
		<?php
		$sdb->query("SELECT id, author, comment, UNIX_TIMESTAMP(datecreated) as datecreated FROM comments WHERE requestid=".$request["id"]." ORDER BY datecreated DESC");
		while ($row = $sdb->getRow()) {
			if ($row["isdeveloperonly"] and !$isdeveloper) {
				$row["comment"] = "[em]An update containing developer-only content was made.[/em]";
			}
			?>
			<item>
				<title><![CDATA[Comment from <?=$row["author"]?>]]></title>
				<description><![CDATA[<?=$row["comment"]?>]]></description>
				<link><![CDATA[http://<?=$_SERVER["HTTP_HOST"]?><?=$baseuri?>/requests/view?id=<?=$row["id"]?>]]></link>
				<guid isPermaLink="false"><?=$row["id"]?></guid>
				<pubDate><?=date("r", $row["datecreated"])?></pubDate>
			</item>
			<?php
		}
		?>
	</channel>
	</rss>
	<?php
}
?>
