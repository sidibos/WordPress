<?php
require_once("../appglobal");




// This file is deprecated, and should no longer be in use.  This error designed to catch cases where it is still being used.
trigger_error('Deprecated code in use', E_USER_DEPRECATED);




// Check input
if (!isset($_POST['id']) or !is_numeric($_POST['id'])) {
	$page->redirectAndAlert('No support request specified');
}
$request = $sdb->queryRow("SELECT * FROM requests WHERE id=".$_POST["id"]);
if (!$request) $page->redirectAndAlert("Could not find that support request");

// Ensure current user has permission to edit this request
$isdeveloper = $sdb->queryRow("SELECT isdeveloper FROM permissions WHERE userid=".$_SESSION["support"]["userid"]." AND ((client='".$request["client"]."' AND project='".$request["project"]."') OR (client='".$request["client"]."' AND project IS NULL) OR (client IS NULL AND project IS NULL)) ORDER BY (project IS NOT NULL AND client IS NOT NULL) DESC, (client IS NOT NULL) DESC LIMIT 1");

// Delete the hashes
$sdb->query("DELETE FROM grouphashes WHERE requestid=".$request["id"]);

// Post a comment
$sdb->query("INSERT INTO comments SET requestid=".$request["id"].", authoruserid=".$_SESSION["support"]["userid"].", author='".$sdb->sqlenc($_SESSION["support"]["username"])."', comment='Detached error codes', isdeveloperonly=1, datecreated=NOW()");

$sdb->query("UPDATE requests SET datemodified=NOW() WHERE id=".$request["id"]);

// Alert and redirect
$page->redirectAndAlert("Error codes detached successfully", "done", "requests/view?id=".$request["id"]);
?>
