<?php
require_once("../appglobal");




// This file is deprecated, and should no longer be in use.  This error designed to catch cases where it is still being used.
trigger_error('Deprecated code in use', E_USER_DEPRECATED);




// Check input
if (!is_array($_POST["requests"])) {
	$page->redirectAndAlert("Invalid request (1)", "error", "requests/");
}
if (sizeof($_POST["requests"]) < 2) {
	$page->redirectAndAlert("You must select at least two requests to combine", "error", "requests/");
}

// Create a comma delimited list of requests
$requests = join(",", $_POST["requests"]);

// Check format
if (!preg_match("/^[0-9]+(\,[0-9]+)*$/", $requests)) {
	$page->redirectAndAlert("Invalid request (2)", "error", "requests/");
}

// Load specified requests
$sdb->query("SELECT COUNT(*) as total, IFNULL(SUM(numoccurences),'NULL') as numoccurences, SUM(charge) as charge, MAX(invoicenum) as invoicenums, MAX(datelastoccurence) as lastoccurence FROM requests WHERE id IN (".$requests.")");
$reqdata = $sdb->getRow();
$reqdata["earliest"] = $sdb->querySingle("SELECT id FROM requests WHERE id IN (".$requests.") ORDER BY datecreated ASC LIMIT 1");
if ($reqdata["total"] != sizeof($_POST["requests"])) {
	$page->redirectAndAlert("Invalid request (3)", "error", "requests/");
}

// Update the earliest request
$sdb->query("UPDATE requests SET numoccurences=".$reqdata["numoccurences"].", charge=".$reqdata["charge"].", invoicenum='".$reqdata["invoicenums"]."', datelastoccurence='".$reqdata["lastoccurence"]."' WHERE id=".$reqdata["earliest"]);

// Reassign all the tracking codes to the earliest occurence
$sdb->query("UPDATE grouphashes SET requestid=".$reqdata["earliest"]." WHERE requestid IN (".$requests.")");

// Reassign all the debug logs to the earliest occurence
$sdb->query("UPDATE debuglogs SET requestid=".$reqdata["earliest"]." WHERE requestid IN (".$requests.")");

// Reassign all the comments to the earliest occurence
$sdb->query("UPDATE comments SET requestid=".$reqdata["earliest"]." WHERE requestid IN (".$requests.")");

// Reassign all the occurences to the earliest occurence
$sdb->query("UPDATE occurences SET requestid=".$reqdata["earliest"]." WHERE requestid IN (".$requests.")");

// Insert deleted request data as comments on earliest request
$sdb->query("INSERT INTO comments (requestid,authoruserid,author,comment,datecreated,filename) SELECT ".$reqdata["earliest"].",20,'System',CONCAT('Support request combined by ".$sdb->sqlenc($_SESSION["support"]["username"]).":\n\nAuthor: ', u1.displayname,'\nTitle: ',title,'\nDate: ',DATE_FORMAT(datecreated,'".$_SERVER["MYSQLDATE"]."'),'\nDescription: ',IFNULL(description,'(none)')),NOW(),filename FROM requests LEFT JOIN users u1 ON (u1.id = requests.authoruserid) WHERE requests.id IN (".$requests.") AND requests.id <> ".$reqdata["earliest"]);

// Delete all requests except the earliest one
$sdb->query("DELETE FROM requests WHERE id IN (".$requests.") AND id <> ".$reqdata["earliest"]);

// Create redirects
$redirs = array();
foreach ($_POST["requests"] as $id) {
	if ($id != $reqdata["earliest"]) $redirs[] = "(".$id.", ".$reqdata["earliest"].")";
}
$sdb->query("REPLACE INTO redirects (oldrequestid, newrequestid) VALUES ".join(",", $redirs));

// Alert and redirect
$page->redirectAndAlert($reqdata["total"]." support requests combined into one. <a href=\"requests/view?id=".$reqdata["earliest"]."\">View combined request</a>", "done", "requests/");
?>
