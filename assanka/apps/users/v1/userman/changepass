<?php



// This file is deprecated, and should no longer be in use.  This error designed to catch cases where it is still being used.
trigger_error('Deprecated code in use', E_USER_DEPRECATED);




require_once("../appglobal");

if (empty($_REQUEST["id"])) $page->redirectAndAlert("User not specified");
$user = $auth->getDetailsForUser($_REQUEST["id"]);
if ($user===false) $page->goBackAndReport("User not found");

$frm = new Inputform("edituser");
$grp = new Simplefieldgroup($frm);

$grp->addField("id", array("inputtype"=>"hidden"));
$grp->addField("username", array("label"=>"Username", "inputtype"=>"dummy"));
$grp->addField("password", array("label"=>"Password", "required"=>true, "validation"=>"/^\S{4,}$/", "validationmsg"=>"Your password is too short or includes spaces", "helptext"=>"Enter a password.  It is a good idea to include numbers or punctuation in your password to make it more secure.  If you have trouble thinking of one, click the button for a suggestion."));
if (!empty($user['email'])) {
	$grp->addField("sendpass", array("label"=>"Send password to user by email", "inputtype"=>"check"));
} else {
	$grp->addField("sendpass", array("label"=>"", "value"=>"Email address unknown: the user will not be notified of their new password", "inputtype"=>"dummy"));
}

$page->addAction("Save", array("javascript"=>"document.frmedituser.submit()"));
$page->addAction("Cancel", "index");

if ($_POST) {
	$grp->addData($_POST);
	$data = $grp->getSubmittedData();
	if ($grp->checkValidity()) {
		$auth->setPassword($data["id"], $data["password"]);
		$page->alert("Password changed successfully", "done");
		if ($data['sendpass'] and !empty($user['email'])) {
			require_once($_SERVER['CORE_PATH']."/helpers/mail/v1/mail");
			$url = ((!empty($_SERVER["HTTPS"])) ? "https":"http") . "://".$_SERVER["HTTP_HOST"].$page->getRoot();
			$em = new Email();
			$em->addRecipient($user['email']);
			$em->setSubject('New password notification');
			$em->setText("This is an automated notification to let you know that your password for accessing an Assanka-managed administration site has changed.  The new password, and the site to which it applies, are shown below:\n\nSite:          ".$url."\nUsername:      ".$data['id']."\nNew password:  ".$data['password']."\n\nYour email system is not a secure place to store passwords.  We recommend that you commit this password to memory, or store it in a more secure location, and delete this email.");
			$em->setFrom('Assanka <noreply@assanka.net>');
			$em->setBounceTo('noreply@assanka.net');
			$em->send();
			$page->alert("Password details have been sent to the user by email", "done");
		}
		header("Location: view?id=".$data["id"]);
		exit;
	} else {
		$page->alert("There was something wrong with your submission.  Please review the highlighted fields below", "error");
	}
} else {
	$grp->addData(array("username"=>$_GET["id"], "id"=>$_GET["id"]));
	$page->alert("Change a user's password below.  Note that if this user is currently logged in they may be forced to re-authenticate.");
}

$page->add($frm->getOutput());

$page->set("title", "Change password");
$page->outputHTML();
?>