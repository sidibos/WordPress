<?php
/**
 * Works with browse to provide an interface for selecting items in
 * the CMS hierarchy.
 *
 * Accepted Inputs: (GET)	type - type of action, used for warning
 * text. Eg move, new (GET)	tag - tag of the current item, used to
 * display and highlight it
 *
 * @copyright The Financial Times Limited [All Rights Reserved]
 */

require_once("../lib/inc/global");



// This file is deprecated, and should no longer be in use.  This error designed to catch cases where it is still being used.
trigger_error('Deprecated code in use', E_USER_DEPRECATED);



$auth->checkRights("outline.user");

$formatsrow = $db->queryRow("SELECT dateformat, timeformat FROM out_languages WHERE isocode=%s", $_SESSION["outline"]["language"]);
$dateFormat = $formatsrow["dateformat"];
$timeFormat = $formatsrow["timeformat"];

// Proceed to set up the page and lay out common javascript, as well
// as some styles required only on this page.
?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" style="border: 0;">
<head>
<base href="<?=$page->getAppRootURI()?>" />
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<title>Outline Browser</title>
<script type="text/javascript" src="lib/js/outline"></script>
<script type="text/javascript">
	oltree = new OutlineTreeView('<?=((!empty($_SESSION["outline"]["sites"][$_SESSION["outline"]["currentsiteid"]]["hostname"]))?$_SESSION["outline"]["sites"][$_SESSION["outline"]["currentsiteid"]]["hostname"]:$_SERVER['HTTP_HOST'])?>', '', false, 'page');
	oltree.changemode("browse", "<?=(empty($_GET["type"])?"":$_GET["type"])?>", "<?=(empty($_GET["extra"])?"":$_GET["extra"])?>");
</script>
<link rel="stylesheet" type="text/css" href="lib/css/outline" />
</head>
<body style="background-color: rgb(240,240,240); font-family: sans-serif; font-size: 12px; border: 0;">
<?php
if (empty($_SESSION["outline"]["browsesiteid"])) $_SESSION["outline"]["browsesiteid"] = $_SESSION["outline"]["currentsiteid"];

$sitesoptionlist = "";
foreach ($_SESSION["outline"]["sites"] as $site) {
	if (!empty($_GET["siteid"]) and $_GET["siteid"] == $site["id"]) $_SESSION["outline"]["browsesiteid"] = $site["id"];
	if ($site["id"] == $_SESSION["outline"]["browsesiteid"]) echo ("<script>parent.selectedSite = '".$site["id"]."'; parent.selectedSiteName = '".$site["name"]."'; parent.selectedSiteRoot = '".$site["webroot"]."';</script>");
	$sitesoptionlist .= "<option value=\"".$site["id"]."\"".(($_SESSION["outline"]["browsesiteid"] == $site["id"])?" selected=\"selected\"":"").">".$site["name"]."</option>";
}
	
if (count($_SESSION["outline"]["sites"]) > 1) {
	$page->set("sitesoptionlist", $sitesoptionlist);
	$page->set("formaction", "browse/browseinner");
	echo $page->render("../lib/tem/multisitebar");
}


// Check for the presence of a home page in the table **todo** - languages??
$db->disableInjectionChecking();
$result = $db->query("SELECT l.id, v.id AS versionid, i.id AS itemid, title, DATE_FORMAT(datecreated, '".$dateFormat." ".$timeFormat."') as datecreated, authoruser, draftuser, l.tag, islive, visibility FROM out_items i LEFT JOIN out_localcontent l ON i.id = l.itemid LEFT JOIN out_versions v ON l.id = v.localcontentid WHERE tag='homepage' AND (islive=1".((!empty($_GET["type"]) and $_GET["type"] == "link")?" OR draftuser IS NOT NULL":"").") AND siteid='".$_SESSION["outline"]["browsesiteid"]."' AND languageisocode='".$_SESSION["outline"]["language"]."' ORDER BY islive DESC, draftuser!='".$db->sqlenc($_SESSION["outline"]["adminuser"])."' ASC, datecreated ASC LIMIT 1");
$db->enableInjectionChecking();
// If a home page is present, output it as an editable page - sans drafts.
if ($db->getNumResults($result)) {
	$row = $db->getRow($result);
	
	if (!empty($_GET["type"]) and $_GET["type"] == "link") {
		$iseditable = ($row["draftuser"] or $row["visibility"] == "inaccessible")?false:true;
	} else if (!empty($_GET["type"]) and $_GET["type"] == "permissions") {
		$iseditable = true;
	} else {
		if (!empty($_GET["extra"]) and (strpos("/".$row["tag"]."/", $_GET["extra"]."/") !== false)) {
			$iseditable = false;
		} else {
			$iseditable = ((outlineCheckIfAuth("editpage", "homepage", false, false, $_SESSION["outline"]["browsesiteid"]))?true:false);
		}
	}
	$homepageid = $row["itemid"];
	$homepageauthor = $row["authoruser"]?$auth->getDetailsForUser($row["authoruser"]):false;
	echo outlineGetTreeViewRowHTML($row["id"], ($row["title"])?$row["title"]:"Home Page", "homepage", (($homepageauthor)?$homepageauthor["displayname"]:$row["authoruser"]), $row["datecreated"], $iseditable, true, false, false, false, true, "visible", false, true);
	
// If no home page is present in the tables, create a non-editable
// home page as a top-level folder
} else {
	if (!empty($_GET["type"]) and $_GET["type"] == "link") $iseditable = true;
	else $iseditable = ((outlineCheckIfAuth("editpage", "homepage", false, false, $_SESSION["outline"]["browsesiteid"]))?true:false);
	echo outlineGetTreeViewRowHTML("0", "Home Page", "homepage", "", "", $iseditable, true, false, false, false, true, "visible", false, true);
	$homepageid = false;
}

// Ensure the homepage is selected if applicable
if (!empty($_GET["tag"]) and ($_GET["tag"] == "/" or $_GET["tag"] == "homepage" or $_GET["tag"] == "/homepage" or $_GET["tag"] == "/homepage/")) {
	echo("<script type=\"text/javascript\">oltree.selectrow(false, '".(($db->getNumResults($result))?$row["id"]:0)."', '".(($row["title"])?$row["title"]:addslashes("Home Page"))."', 'homepage', ".(($iseditable)?"true":"false").", false, false, '', '', true);</script>");
}

// Fetch all pages for which the home page is a parent; this calls
// a recursive function to generate the folder tree.
echo outlineGetTreeChildrenHTML("(parentid IS NULL OR parentid=0".(($homepageid)?" OR parentid=".$homepageid:"").")", 1, $_SESSION["outline"]["language"], $dateFormat, $timeFormat, $_SESSION["outline"]["browsesiteid"], false, true, true);

?>
<div id="waitholder" style="display: none;">
<div class="treepad" style="clear: both;">&nbsp;</div>
<div class="treepad"><img src="lib/img/icons/icon_wait.gif" height=14 width=19 /></div><span class="ctext hidden">Loading folder, please wait...</span>
</div><br /><br />
</body>
</html>
