<?php
/**
 * CMS Index Page - Lists all pages in the CMS, for a user to select
 * and edit, sort, add to or delete from. Displays a tree structure
 * of the site, with all pages visible if there are less than ten;
 * otherwise, displays a collapsed top-level.
 *
 * Accepted Inputs: none
 *
 * @copyright The Financial Times Limited [All Rights Reserved]
 */

require_once("../lib/inc/global");



// This file is deprecated, and should no longer be in use.  This error designed to catch cases where it is still being used.
trigger_error('Deprecated code in use', E_USER_DEPRECATED);



$auth->checkRights("outline.user");

$formatsrow = $db->queryRow("SELECT dateformat, timeformat FROM out_languages WHERE isocode=%s", $_SESSION["outline"]["language"]);
$dateFormat = $formatsrow["dateformat"];
$timeFormat = $formatsrow["timeformat"];

outlineCheckIfAuth("viewpage", false, $auth->user["username"], true, $_SESSION["outline"]["currentsite"]);
if (count($_SESSION["outline"]["sites"]) > 1) {
	$sitesoptionlist = "";
	foreach ($_SESSION["outline"]["sites"] as $site) {
		$sitesoptionlist .= "<option value=\"".$site["id"]."\"".(($_SESSION["outline"]["currentsite"] == $site["id"])?" selected=\"selected\"":"").">".$site["name"]."</option>";
	}
	$page->set("sitesoptionlist", $sitesoptionlist);
	$page->set("formaction", "pages/index");
	$page->add("content", $page->render("../lib/tem/multisitebar"));
}


$page->set("treeviewjs", "'".((!empty($_SESSION["outline"]["sites"][$_SESSION["outline"]["currentsiteid"]]["hostname"]))?$_SESSION["outline"]["sites"][$_SESSION["outline"]["currentsiteid"]]["hostname"]:$_SERVER['HTTP_HOST'])."', '".$_SESSION["outline"]["sites"][$_SESSION["outline"]["currentsite"]]["webroot"]."', ".((outlineIsFunctionalityEnabled("versionhistory"))?"true":"false").", 'page'");
$treehtml = "";

// Check for the presence of a home page - if it exists retrieve it and any active drafts
$result = $db->query("SELECT l.id, v.id AS versionid, i.id AS itemid, title, DATE_FORMAT(datecreated, %s) as datecreated, authoruser, draftuser, islive FROM out_items i LEFT JOIN out_localcontent l ON i.id = l.itemid LEFT JOIN out_versions v ON l.id = v.localcontentid WHERE tag=%s AND (islive=1 OR draftuser IS NOT NULL) AND siteid=%s AND languageisocode=%s ORDER BY islive DESC, draftuser!=%s ASC, datecreated ASC", $dateFormat." ".$timeFormat, "homepage", $_SESSION["outline"]["currentsite"], $_SESSION["outline"]["language"], $auth->user["username"]);

// If a home page is present, output it as an editable page
if ($db->getNumResults($result)) {
	$homepage = $db->getRow($result);
	$homepageid = $homepage["itemid"];
	
	// Add the drafts
	$draftshtml = "";
	$originalversionid = $homepage["versionid"];
	while ($drow = $db->getRow($result)) {
		$author = $drow["authoruser"]?$auth->getDetailsForUser($drow["authoruser"]):false;
		$draftshtml .= outlineGetDraftHTML($originalversionid, $drow["versionid"], $drow["draftuser"], $drow["authoruser"], (($author)?$author["displayname"]:$drow["authoruser"]), false);
	}
	$iseditable = ((outlineCheckIfAuth("editpage", "homepage", false, false, $_SESSION["outline"]["currentsite"]))?true:false);
	$issortable = ((outlineCheckIfAuth("sortpage", "homepage", false, false, $_SESSION["outline"]["currentsite"]))?true:false);
	$homepageauthor = $homepage["authoruser"]?$auth->getDetailsForUser($homepage["authoruser"]):false;
	$homehtml = outlineGetTreeViewRowHTML($homepage["id"], ($homepage["title"])?$homepage["title"]:"Home Page", "homepage", (($homepageauthor)?$homepageauthor["displayname"]:$homepage["authoruser"]), $homepage["datecreated"], $iseditable, true, false, $issortable, false, true, "visible", $draftshtml, false);

// If no home page is present, display a non-editable home page to establish context.
} else {
	$homepageid = false;
	$issortable = ((outlineCheckIfAuth("sortpage", "homepage", false, false, $_SESSION["outline"]["currentsite"]))?true:false);
	$homehtml = outlineGetTreeViewRowHTML("0", "Home Page", "homepage", "", "This page is managed outside the CMS", false, true, false, $issortable, false, true, "visible", "", false);
}
$page->set("homepagehtml", $homehtml);

// Fetch all pages for which the home page is a parent; this calls
// a recursive function to generate the folder tree.
$treehtml = outlineGetTreeChildrenHTML("(parentid IS NULL OR parentid=0".(($homepageid)?" OR parentid=".$homepageid:"").")", 1, $_SESSION["outline"]["language"], $dateFormat, $timeFormat, $_SESSION["outline"]["currentsite"], true, false, true);
$page->set("treehtml", $treehtml);

$page->add("content", $page->render("../lib/tem/index"));
$page->add("rightnav", $page->render("../lib/tem/indexsidebar"));

$page->addAction("Add Page", array("domid"=>"add", "href"=>"pages/new"));
$page->addAction("Edit Page", array("domid"=>"edit", "href"=>"pages/edit", "hidden"=>true));
$page->addAction("Sort Subsections", array("domid"=>"sort", "href"=>"pages/sort", "hidden"=>true));
$page->addAction("Page History", array("domid"=>"history", "href"=>"pages/viewhistory", "hidden"=>true));
$page->addAction("Delete", array("domid"=>"delete", "javascript"=>"oltree.submitfordelete()", "hidden"=>true));

$page->set("title", "View pages");
$page->outputHTML();
?>
