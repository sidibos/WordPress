<?php
/**
 * Deletes a page from the database, along with its history
 *
 * Accepted Inputs: (GET) id: out_localcontent.id of page to delete
 *
 * @copyright The Financial Times Limited [All Rights Reserved]
 */

require_once("../lib/inc/global");



// This file is deprecated, and should no longer be in use.  This error designed to catch cases where it is still being used.
trigger_error('Deprecated code in use', E_USER_DEPRECATED);



$auth->checkRights("outline.user");
if (empty($_GET["id"]) or !is_numeric($_GET["id"])) $page->redirectAndAlert("Invalid item requested for deletion", "error");
$rec = $db->queryRow("SELECT itemid, tag FROM out_localcontent WHERE id=".$_GET["id"]);
if (!$rec) $page->redirectAndAlert("Item to be deleted has already been deleted or never existed", "error");

// Grab the item type and use it to determine whether the user has
// the rights to delete this item
$row = $db->queryRow("SELECT type, siteid FROM out_items WHERE id=".$rec["itemid"]);
outlineCheckIfAuth("delete".$row["type"], (($row["type"]=="page")?$rec["tag"]:""), "", true, $row["siteid"]); 

// Store the parent folder in the user's preferences if there is one
if (strrpos($rec["tag"], "/")) outlineSaveLastSelectedPage(substr($rec["tag"], 0, strrpos($rec["tag"], "/")));
else outlineSaveLastSelectedPage("/");

// Proceed with the deletion
$db->query("DELETE FROM out_items WHERE id=".$rec["itemid"]);
$result = $db->query("SELECT id, tag, languageisocode FROM out_localcontent WHERE itemid=".$rec["itemid"]);
while ($rec = $db->getRow($result)) {

	// First, remove the versions, adding actionlog lines for each
	$result2 = $db->query("SELECT id FROM out_versions WHERE localcontentid=".$rec["id"]);
	while ($rec2 = $db->getrow($result2)) {
		$db->query("INSERT INTO out_actionlog SET versionid=".$rec2["id"].", user='".$auth->user["username"]."', actiontype='delete', comment='', date=NOW()");
	}
	$db->query("DELETE FROM out_versions WHERE localcontentid=".$rec["id"]);
	
	// Delete the localcontent
	$db->query("DELETE FROM out_localcontent WHERE id=".$rec["id"]);
	
}

// Delete the cache, if any - site-wide as navigation may be affected
outlineDeleteCache($row["siteid"]);

if ($row["type"] == "asset" or $db->getRowsAffected()) {
	$page->redirectAndAlert("Item deleted successfully.", "done", $row["type"]."s/");
} else {
	trigger_error("Unexpected result", E_USER_ERROR);
}
?>
