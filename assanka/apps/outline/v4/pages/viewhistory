<?php
/**
 * CMS history page - displays all versions for a specific page or
 * asset, not including drafts, and provides an interface for
 * comparing versions.
 *
 * Accepted Inputs: (GET) id: id of item to look up the history for.
 * (GET) [makelive]: id of version to mark as live
 *
 * @copyright The Financial Times Limited [All Rights Reserved]
 */

require_once("../lib/inc/global");



// This file is deprecated, and should no longer be in use.  This error designed to catch cases where it is still being used.
trigger_error('Deprecated code in use', E_USER_DEPRECATED);



$auth->checkRights("outline.user");

// Error if version control is disabled for this project
if (!outlineIsFunctionalityEnabled("versionhistory")) trigger_error(APPNAME." does not have the correct permissions to use version control.", E_USER_ERROR);

$formatsrow = $db->queryRow("SELECT dateformat, timeformat FROM out_languages WHERE isocode='".$_SESSION["outline"]["language"]."'");
$dateFormat = $formatsrow["dateformat"];
$timeFormat = $formatsrow["timeformat"];

// Retrieve page ID from query string
if (preg_match("/viewhistory\/([0-9]+)\/?($|\?.*$)/", $_SERVER["REQUEST_URI"], $matches)) {
	$localcontentid = $matches[1];
} else {
	$page->redirectAndAlert("You tried to view a page history, but no id was supplied, or the id was not numeric.  The ID should always be filled in automatically if you followed a link from another page; if you believe you are seeing this in error, please contact support.", "error", "pages/");
}

$liveitem = $db->queryRow("SELECT siteid, title, tag, type FROM out_items i LEFT JOIN out_localcontent l ON i.id=l.itemid LEFT JOIN out_versions v ON l.id=v.localcontentid WHERE l.id=".$localcontentid." AND islive=1");
if (!$liveitem) trigger_error("Record not found", E_USER_ERROR);

// Save the location of this page for redisplay of index
outlineSaveLastSelectedPage($liveitem["tag"]);

// If the "mark an item as live" function is being used, detag all versions and then mark the selected version as live
if (!empty($_GET["makelive"]) and is_numeric($_GET["makelive"])) {
	outlineCheckIfAuth("publish".$liveitem["type"], $liveitem["tag"], $auth->user["username"], true, $liveitem["siteid"]);
	$newliveitem = $db->queryRow("SELECT title FROM out_versions WHERE id=".$_GET["makelive"]." AND localcontentid=".$localcontentid);
	if (!$newliveitem) trigger_error("Record not found", E_USER_ERROR);
	
	// If the new title doesn't match the old one, flush the site
	// cache due to navigation changing
	if ($newliveitem["title"] != $liveitem["title"]) {
		outlineDeleteCache($liveitem["siteid"]);

	// Otherwise delete just the cache of this page
	} else {
		outlineDeleteCacheForPage($liveitem["tag"], $_SESSION["outline"]["language"], $liveitem["siteid"]);
	}

	// Outline extension: run a process following an item being marked as live
	$extendarray = array(&$localcontentid, &$_GET["makelive"]);
	outlineExtend("changeLiveVersionForPage", $extendarray);

	$db->query("UPDATE out_versions SET islive=0 WHERE localcontentid=".$localcontentid);
	$db->query("UPDATE out_versions SET islive=1 WHERE id=".$_GET["makelive"]);
	$db->query("INSERT INTO out_actionlog SET versionid=".$_GET["makelive"].", user='".$auth->user["username"]."', actiontype='change live', comment='', date=NOW()");
}

// Create a new data table
$tb = new datatable("versions", "version", 200, false, false);

// Define columns
$tb->addColumn("icon", "", false, false, 18);
$tb->addColumn("modifiedlong", "Revision date", "DESC");
$tb->addColumn("author", "Revision author", "ASC");
$tb->addColumn("status", "Revision status", "ASC");
$tb->addColumn("comparison", "Revision comparison", "ASC");

// Set default sort-by column
$tb->setSort("modifiedlong");

// Load all non-draft versions of the selected item id
$result = $db->query("SELECT v.id, title, datecreated AS modifiedlong, DATE_FORMAT(datecreated, '".$dateFormat." ".$timeFormat."') as fmodifiedlong, authoruser, islive FROM out_localcontent l LEFT JOIN out_versions v ON l.id=v.localcontentid WHERE l.id=".$localcontentid." AND draftuser IS NULL ORDER BY datecreated DESC");

$rownumber = 0;
while ($row = $db->getRow($result)) {
	$rownumber++;
	$author = $row["authoruser"]?$auth->getDetailsForUser($row["authoruser"]):false;
	$row["author"] = $author?$author["displayname"]:$row["authoruser"];
	
	$row["modifiedlong"] = $row["fmodifiedlong"];
	$row["icon"] = "<img src=\"lib/img/icons/icon16_".$liveitem["type"].(($row["islive"])?"":"hidden").".gif\">";
	$row["status"] = (($row["islive"])?"<strong>Currently Live</strong>":"<a href=\"".$liveitem["type"]."s/viewhistory/".$localcontentid."?makelive=".$row["id"]."\">Publish</a>");
	$row["comparison"] = "<a href=\"javascript:void(0);\" onclick=\"olhistory.selectRevision(".$row["id"].", '".$row["fmodifiedlong"]." by ".$row["author"]."', ".(($rownumber == $db->getNumResults($result))?"true":"false").", ".(($row["islive"])?"true":"false").", this);\">Select for comparison</a>";

	$tb->addRow($row, false);
	$tb->setCellClass("modifiedlong", "vcenter");
	$tb->setCellClass("author", "vcenter");
	$tb->setCellClass("status", "vcenter");
	$tb->setCellClass("comparison", "vcenter");
}

// Construct the page
$page->set($liveitem);
$page->add("content", $tb->outputTable());
$page->add("content", "<style type=\"text/css\">.vcenter { line-height: 1.3em; }</style>");
$page->add("rightnav", $page->render("../lib/tem/historysidebar"));
$page->set("title", "View ".$liveitem["type"]." history - '".$liveitem["title"]."'");

$page->outputHTML();
?>