<?php
/**
 * Creates a new blank asset, and redirects to the edit page to edit
 * it
 *
 * Accepted Inputs: none
 *
 * @copyright The Financial Times Limited [All Rights Reserved]
 */

require_once("../lib/inc/global");



// This file is deprecated, and should no longer be in use.  This error designed to catch cases where it is still being used.
trigger_error('Deprecated code in use', E_USER_DEPRECATED);



$auth->checkRights("outline.user");
outlineCheckIfAuth("createasset", "", "", true);

// If the account has draft privileges, create the new version as a draft -
// the advantage of this is it's not visible until published.  Without
// draft functionality, the default page gets created as-is.
$db->disableInjectionChecking();
$db->query("INSERT INTO out_items SET siteid='0', parentid=0, type='asset', sortindex=1, visibility='visible'");
$pageItemID = $db->getInsertId();
$db->query("INSERT INTO out_localcontent SET itemid=".$pageItemID.", languageisocode='en', tag='', isuptodate=1");
$localContentID = $db->getInsertId();
if (outlineIsFunctionalityEnabled("drafts")) {
	$db->query("INSERT INTO out_versions SET localcontentid=".$localContentID.", authoruser='".$auth->user["username"]."', draftuser='".$auth->user["username"]."', versionnumber=0, title='Untitled Asset', html='', datecreated=NOW(), islive=0");
	$page->alert("Asset created successfully as a draft.", "done");
} else {
	$db->query("INSERT INTO out_versions SET localcontentid=".$localContentID.", authoruser='".$auth->user["username"]."', draftuser=NULL, versionnumber=0, title='Untitled Asset', html='', datecreated=NOW(), islive=1");
	$page->alert("Asset created successfully.", "done");
}

// Forward to edit page after writing action log
if ($db->getRowsAffected()) {
	$_SESSION["infotype"] = "done";
	if (outlineIsFunctionalityEnabled("drafts")) {
		$versionID = $db->getInsertId();
		$db->query("INSERT INTO out_actionlog SET versionid=".$versionID.", user='".$auth->user["username"]."', actiontype='create asset', comment='', date=NOW()");
		$page->redirect("assets/edit?id=".$versionID."&type=draft");
	} else {
		$db->query("INSERT INTO out_actionlog SET versionid=".$db->getInsertId().", user='".$auth->user["username"]."', actiontype='create asset', comment='', date=NOW()");
		$page->redirect("assets/edit?id=".$localContentID);
	}
} else {
	trigger_error("Unexpected result", E_USER_ERROR);
}
?>