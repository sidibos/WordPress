<?php
/**
 * Outputs children of a folder in basic xml format; in fact this
 * file constructs and returns the html in complete form, and the
 * index page simply inserts it.
 *
 * Accepted Inputs: (GET) id: id of element to fetch the children
 * from (GET) hidedrafts: whether to hide drafts
 *
 * @copyright The Financial Times Limited [All Rights Reserved]
 */
require_once("../inc/global");



// This file is deprecated, and should no longer be in use.  This error designed to catch cases where it is still being used.
trigger_error('Deprecated code in use', E_USER_DEPRECATED);



$eh->verbosereport = false;

header("Content-Type: text/xml");
if (!is_numeric($_GET["id"])) {
	header("HTTP/1.0 400 Bad Request");
	exit;
}

// Grab the itemid
$result = $db->query("SELECT itemid, languageisocode FROM out_localcontent WHERE id=%s", $_GET["id"]);
if (!$db->getNumResults($result)) {
	header("HTTP/1.0 400 Bad Request");
	exit;
} else {
	$row = $db->getRow($result);
	$theItemID = $row["itemid"];
	$languageisocode = $row["languageisocode"];
}
$formats = $db->query("SELECT dateformat, timeformat FROM out_languages WHERE isocode=%s", $languageisocode);
$formatsrow = $db->getRow($formats);
$dateFormat = $formatsrow["dateformat"];
$timeFormat = $formatsrow["timeformat"];

// Begin with construction of the item; fetch all the direct children,
// including stored drafts.
$result = $db->query("SELECT i.id as itemid, i.siteid, l.id as contentid, v.id AS versionid, title, DATE_FORMAT(datecreated, {dateformat|nokey}) as datecreated, authoruser, draftuser, tag, visibility, islive FROM out_items i LEFT JOIN out_localcontent l ON i.id = l.itemid LEFT JOIN out_versions v ON l.id = v.localcontentid WHERE parentid=".$theItemID." AND (islive=1".((!empty($_GET["hidedrafts"]) and $_GET["hidedrafts"] == "all")?"":" OR draftuser IS NOT NULL").") AND languageisocode={languageisocode|nokey} ORDER BY draftuser IS NULL DESC, sortindex, IF(draftuser IS NULL, title, draftuser!={adminuser|nokey}) ASC, datecreated ASC", array("dateformat"=>$dateFormat." ".$timeFormat, "languageisocode"=>$languageisocode, "adminuser"=>$_SESSION["outline"]["adminuser"]));
	
// Set up a variable to store all rows, for grouping of live and drafts, before outputting at end
$rowsarray = array();
echo("<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\n");

if (!$db->getNumResults($result)) {
	?>
	<response>
	<localcontentid><?=$_GET["id"]?></localcontentid>
	<html><![CDATA[
		<div style="clear: both;">
			<div class="tdb tdnormal">
				<div class="treepad">&nbsp;</div>
				<div class="treepad"><img src="lib/img/icons/icon16_drafthidden.gif" width="16" height="14" /></div>
				<span class="ctext hidden">(Only non-visible pages in this folder)</span>
			</div>
		</div>
	]]></html>
	</response>
	<?php
	exit;
}
?>
<response>
	<localcontentid><?=$_GET["id"]?></localcontentid>
	<html><![CDATA[
		<?php
		while ($row = $db->getRow($result)) {
			
			// If this row doesn't already exist in the row array, create an entry for it
			if (empty($rowsarray[$row["contentid"]])) {
			
				// Before insertion, check whether this row has any children
				$result2 = $db->query("SELECT i.id FROM out_items i WHERE parentid=".$row["itemid"]." LIMIT 0,1");
				
				$isfolder = (($db->getNumResults($result2))?true:false);
				
				// The presence of rows indicates children; if so, display an expandable folder.
				// Also check the saved page tag to see whether the folder should be loaded expanded.
				if ($isfolder) {
					$isdeleteable = false;
					$issortable = ((outlineCheckIfAuth("sortpage", $row["tag"], false, false, $row["siteid"]))?true:false);
				} else {
					$isdeleteable = (($row["draftuser"] == "")?((outlineCheckIfAuth("deletepage", $row["tag"], false, false, $row["siteid"]))?true:false):false);
					$issortable = false;
				}
				
				$iseditable = ((!empty($_GET["extra"]) and (strpos("/".$row["tag"]."/", $_GET["extra"]."/") !== false))?false:(($row["draftuser"] == "")?((outlineCheckIfAuth("editpage", $row["tag"], false, false, $row["siteid"]))?true:false):false));
				$islive = (($row["islive"] && $row["visibility"])?true:false);
				
				// Create the row entry
				$rowauthor = $row["authoruser"]?$auth->getDetailsForUser($row["authoruser"]):false;
				$rowsarray[$row["contentid"]] = array("contentid"=>$row["contentid"], "title"=>$row["title"], "tag"=>$row["tag"], "author"=>(($rowauthor)?$rowauthor["displayname"]:$row["authoruser"]), "datecreated"=>$row["datecreated"], "iseditable"=>$iseditable, "isfolder"=>$isfolder, "issortable"=>$issortable, "isdeleteable"=>$isdeleteable, "islive"=>$islive, "visibility"=>$row["visibility"], "isbrowser"=>!empty($_GET["isbrowser"]), "drafthtml"=>"", "firstversionid"=>$row["versionid"]);
			}
			
			// If appropriate, append a draft record
			if (empty($_GET["hidedrafts"]) and $row["draftuser"]) {
				$rowauthor = (($row["authoruser"])?$auth->getDetailsForUser($row["authoruser"]):false);
				$rowsarray[$row["contentid"]]["drafthtml"] .= outlineGetDraftHTML($rowsarray[$row["contentid"]]["firstversionid"], $row["versionid"], $row["draftuser"], $row["authoruser"], (($rowauthor)?$rowauthor["displayname"]:$row["authoruser"]), false);
			}
		}

		// Loop through the rows array and output each row
		foreach ($rowsarray as $row) {
			echo(outlineGetTreeViewRowHTML($row["contentid"], $row["title"], $row["tag"], $row["author"], $row["datecreated"], $row["iseditable"], $row["isfolder"], false, $row["issortable"], $row["isdeleteable"], $row["islive"], $row["visibility"], $row["drafthtml"], $row["isbrowser"]));
		}?>
	]]></html>
</response>
