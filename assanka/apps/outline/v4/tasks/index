<?php
/**
 * CMS tasks page - displays all drafts available to a user, sent to
 * a user, sent by a user, for pages and assets.
 *
 * These include self-saved drafts, new pages that weren't
 * completed, and pages sent for review by another user.
 *
 * Accepted Inputs: none
 *
 * @copyright The Financial Times Limited [All Rights Reserved]
 */

require_once("../lib/inc/global");



// This file is deprecated, and should no longer be in use.  This error designed to catch cases where it is still being used.
trigger_error('Deprecated code in use', E_USER_DEPRECATED);



$auth->checkRights("outline.user");

// Error if drafts and taskboard aren't enabled for this project
if (!outlineIsFunctionalityEnabled("drafts") or !outlineIsFunctionalityEnabled("taskdashboard")) {
	trigger_error("Project lacks permissions to use the task dashboard functionality.", E_USER_ERROR);
}

$formatsrow = $db->queryRow("SELECT dateformat, timeformat FROM out_languages WHERE isocode='".$_SESSION["outline"]["language"]."'");
$dateFormat = $formatsrow["dateformat"];
$timeFormat = $formatsrow["timeformat"];

// If the post action is retrieve, retrieve before showing page
if (!empty($_GET["action"]) and !empty($_GET["id"]) and $_GET["action"] == "retrieve" and is_numeric($_GET["id"])) {
	$draftuser = $db->querySingle("SELECT draftuser FROM out_versions v LEFT JOIN out_actionlog l ON v.id=l.versionid AND v.datecreated=l.date WHERE v.id=".$_GET["id"]." AND authoruser='".$db->sqlenc($auth->user["username"])."' AND user='".$db->sqlenc($auth->user["username"])."' AND actiontype='send for review'");
	if ($draftuser) {
		$db->query("DELETE l FROM out_actionlog l LEFT JOIN out_versions v ON v.id=l.versionid AND v.datecreated=l.date WHERE v.id=".$_GET["id"]." AND authoruser='".$db->sqlenc($auth->user["username"])."' AND user='".$db->sqlenc($auth->user["username"])."' AND actiontype='send for review'");
		$db->query("UPDATE out_versions SET draftuser='".$db->sqlenc($auth->user["username"])."' WHERE id=".$_GET["id"]);
		$db->query("INSERT INTO out_actionlog SET versionid=".$_GET["id"].", user='".$db->sqlenc($auth->user["username"])."', actiontype='retrieve draft', comment='Draft previously sent to ".$draftuser."', date=NOW()");
	}
}

// Add javascript
$page->add("content", "<script type=\"text/javascript\">var tasktables = new outlineTasksTableGroupHandler();</script>");

// Load drafts sent to this user to review
$drafttoreviewresult = $db->query("SELECT v.id, webroot, title, DATE_FORMAT(datecreated, '".$dateFormat." ".$timeFormat."') as created, comment, a.user AS draftsender, authoruser, type, tag FROM out_items i LEFT JOIN out_localcontent l ON i.id=l.itemid LEFT JOIN out_versions v ON l.id=v.localcontentid LEFT JOIN out_actionlog a ON v.id=a.versionid AND v.datecreated=a.date LEFT JOIN out_sites s ON i.siteid=s.id WHERE draftuser='".$auth->user["username"]."' AND authoruser!='".$auth->user["username"]."' ORDER BY datecreated ASC");
if ($db->getNumResults($drafttoreviewresult)) {
	
	// Create a new data table for drafts sent to this user to review
	$tb = new datatable("draftstoreview", "version", 50, "Drafts Sent To Me For Review", false);
	
	// Define columns
	$tb->addColumn("icon", "", false, false, 18);
	$tb->addColumn("title", "Title", "DESC");
	$tb->addColumn("author", "Draft author", "ASC");
	$tb->addColumn("draftsender", "Sent by", "ASC");
	$tb->addColumn("created", "Sent", "ASC");
	$tb->addColumn("type", "Type", "ASC", false, 60);
	$tb->setSort("created");
	
	$javascriptstring = "";
	while ($row = $db->getRow($drafttoreviewresult)) {
		if ($row["authoruser"] == $auth->user["username"]) {
			$row["author"] = "Me";
		} else {
			$author = $row["authoruser"]?$auth->getDetailsForUser($row["authoruser"]):false;
			$row["author"] = $author?$author["displayname"]:$row["authoruser"];
		}
		$draftsender = $row["draftsender"]?$auth->getDetailsForUser($row["draftsender"]):false;
		$row["draftsender"] = $draftsender?$draftsender["displayname"]:$row["draftsender"];
		
		$row["icon"] = "<img src=\"lib/img/icons/icon16_".$row["type"]."hidden.gif\" id=\"id".$row["id"]."\">";
		$row["type"] = ucfirst($row["type"]);

		$tb->addRow($row, false);
		$javascriptstring .= "draftstoreview.addHandler(".$row["id"].", '<strong>".addslashes($row["title"])."</strong><br />".$row["type"]." draft by ".$row["author"]."<br />".$row["created"]."<br /><br /><strong>You were sent this draft by ".addslashes($row["draftsender"])." with ".(($row["comment"])?"the comment:</strong><br />".addslashes($row["comment"]):"no comment.")."'); ";
	}	
	$page->add("content", $tb->outputTable());
	$page->add("content", "<script type=\"text/javascript\">var draftstoreview = new outlineTasksTableHandler(true, false, tasktables); ".$javascriptstring."</script>");
}


// Load drafts returned to this user
$draftsreturnedresult = $db->query("SELECT v.id, title, DATE_FORMAT(datecreated, '".$dateFormat." ".$timeFormat."') as created, comment, a.user, authoruser, draftuser, type, tag, webroot FROM out_items i LEFT JOIN out_localcontent l ON i.id=l.itemid LEFT JOIN out_versions v ON l.id=v.localcontentid LEFT JOIN out_actionlog a ON v.id=a.versionid AND v.datecreated=a.date LEFT JOIN out_sites s ON i.siteid=s.id WHERE draftuser='".$auth->user["username"]."' AND a.actiontype='return draft' ORDER BY datecreated ASC");
if ($db->getNumResults($draftsreturnedresult)) {
	
	// Create a new data table for drafts returned to this user
	$tb = new datatable("draftsreturned", "version", 50, "Drafts Returned To Me", false);
	
	// Define columns
	$tb->addColumn("icon", "", false, false, 18);
	$tb->addColumn("title", "Title", "DESC");
	$tb->addColumn("author", "Author", "ASC");
	$tb->addColumn("draftreturner", "Returned by", "ASC");
	$tb->addColumn("created", "Sent", "ASC");
	$tb->addColumn("type", "Type", "ASC", false, 60);
	$tb->setSort("created");
	
	$javascriptstring = "";
	while ($row = $db->getRow($draftsreturnedresult)) {
		if ($row["authoruser"] == $auth->user["username"]) {
			$row["author"] = "Me";
		} else {
			$author = $row["authoruser"]?$auth->getDetailsForUser($row["authoruser"]):false;
			$row["author"] = $author?$author["displayname"]:$row["authoruser"];
		}
		$draftreturner = $row["user"]?$auth->getDetailsForUser($row["user"]):false;
		$row["draftreturner"] = $draftreturner?$draftreturner["displayname"]:$row["user"];

		$row["icon"] = "<img src=\"lib/img/icons/icon16_".$row["type"]."hidden.gif\" id=\"id".$row["id"]."\">";
		$row["type"] = ucfirst($row["type"]);

		$tb->addRow($row, false);
		$javascriptstring .= "draftsreturned.addHandler(".$row["id"].", '<strong>".addslashes($row["title"])."</strong><br />".$row["type"]." draft by ".$row["author"]."<br />".$row["created"]."<br /><br /><strong>Draft returned by ".addslashes($row["draftreturner"])." with ".(($row["comment"])?"the comment:</strong><br />".addslashes($row["comment"]):"no comment.")."'); ";
	}	
	$page->add("content", $tb->outputTable());
	$page->add("content", "<script type=\"text/javascript\">var draftsreturned = new outlineTasksTableHandler(true, false, tasktables); ".$javascriptstring."</script>");
}



// Load drafts saved by this user
$mydraftsresult = $db->query("SELECT v.id, title, DATE_FORMAT(datecreated, '".$dateFormat." ".$timeFormat."') as created, type, tag, webroot FROM out_items i LEFT JOIN out_localcontent l ON i.id=l.itemid LEFT JOIN out_versions v ON l.id=v.localcontentid LEFT JOIN out_actionlog a ON v.id=a.versionid AND v.datecreated=a.date LEFT JOIN out_sites s ON i.siteid=s.id WHERE draftuser='".$auth->user["username"]."' AND authoruser='".$auth->user["username"]."' AND ((a.actiontype != 'send for review' AND a.actiontype != 'return draft') OR a.actiontype IS NULL) ORDER BY datecreated ASC");
if ($db->getNumResults($mydraftsresult)) {
	
	// Create a new data table for drafts saved by this user
	$tb = new datatable("mydrafts", "version", 50, "Drafts I've Saved", false);
	
	// Define columns
	$tb->addColumn("icon", "", false, false, 18);
	$tb->addColumn("title", "Title", "DESC");
	$tb->addColumn("created", "Last modified", "ASC");
	$tb->addColumn("type", "Type", "ASC", false, 60);
	$tb->setSort("created");
	
	$javascriptstring = "";
	while ($row = $db->getRow($mydraftsresult)) {
		$row["icon"] = "<img src=\"lib/img/icons/icon16_".$row["type"]."hidden.gif\" id=\"id".$row["id"]."\">";
		$row["type"] = ucfirst($row["type"]);
		$tb->addRow($row, false);
		$javascriptstring .= "mydrafts.addHandler(".$row["id"].", '<strong>".addslashes($row["title"])."</strong><br />".$row["type"]." draft by ".$auth->user["displayname"]."<br />".$row["created"]."'); ";
	}
	$page->add("content", $tb->outputTable());
	$page->add("content", "<script type=\"text/javascript\">var mydrafts = new outlineTasksTableHandler(true, false, tasktables); ".$javascriptstring."</script>");
}



// Load drafts sent by this user
$draftssentresult = $db->query("SELECT v.id, title, DATE_FORMAT(datecreated, '".$dateFormat." ".$timeFormat."') as created, comment, a.user, authoruser, draftuser, type, tag, webroot FROM out_items i LEFT JOIN out_localcontent l ON i.id=l.itemid LEFT JOIN out_versions v ON l.id=v.localcontentid LEFT JOIN out_actionlog a ON v.id=a.versionid AND v.datecreated=a.date LEFT JOIN out_sites s ON i.siteid=s.id WHERE draftuser!='".$auth->user["username"]."' AND authoruser='".$auth->user["username"]."' ORDER BY datecreated ASC");
if ($db->getNumResults($draftssentresult)) {
	
	// Create a new data table for drafts sent by this user
	$tb = new datatable("draftssent", "version", 50, "Drafts Sent For Review", false);
	
	// Define columns
	$tb->addColumn("icon", "", false, false, 18);
	$tb->addColumn("title", "Title", "DESC");
	$tb->addColumn("draftsender", "Sent from", "DESC");
	$tb->addColumn("draftuser", "Sent to", "DESC");
	$tb->addColumn("created", "Sent", "ASC");
	$tb->addColumn("type", "Type", "ASC", false, 60);
	$tb->setSort("created");
	
	$javascriptstring = "";
	while ($row = $db->getRow($draftssentresult)) {
		if ($row["user"] == $auth->user["username"]) {
			$row["draftsender"] = "Me";
		} else {
			$draftsender = $row["user"]?$auth->getDetailsForUser($row["user"]):false;
			$row["draftsender"] = $draftsender?$draftsender["displayname"]:$row["user"];
		}
		$draftuser = $row["draftuser"]?$auth->getDetailsForUser($row["draftuser"]):false;
		$row["draftuser"] = $draftuser?$draftuser["displayname"]:$row["draftuser"];
		$authoruser = $row["authoruser"]?$auth->getDetailsForUser($row["authoruser"]):false;
		$row["author"] = $authoruser?$authoruser["displayname"]:$row["authoruser"];

		$row["icon"] = "<img src=\"lib/img/icons/icon16_".$row["type"]."hidden.gif\" id=\"id".$row["id"]."\">";
		$row["type"] = ucfirst($row["type"]);

		$tb->addRow($row, false);
		$javascriptstring .= "draftssent.addHandler(".$row["id"].", '<strong>".addslashes($row["title"])."</strong><br />".$row["type"]." draft by ".$row["author"]."<br />".$row["created"]."<br /><br />".(($row["user"] == $auth->user["username"])?"<strong>Draft sent to ".$row["draftuser"]." with ".(($row["comment"])?"the comment:</strong><br />".addslashes($row["comment"]):"no comment."):"This draft has been forwarded from ".$row["draftsender"]." to ".$row["draftuser"]." for further review.")."'); ";
	}	
	$page->add("content", $tb->outputTable());
	$page->add("content", "<script type=\"text/javascript\">var draftssent = new outlineTasksTableHandler(false, true, tasktables); ".$javascriptstring."</script>");
}

if ($db->getNumResults($drafttoreviewresult) or $db->getNumResults($draftsreturnedresult) or $db->getNumResults($mydraftsresult) or $db->getNumResults($draftssentresult)) {
	$page->alert("Please select a draft to see details and associated tasks.");
	$page->add("rightnav", $page->render("../lib/tem/tasksidebar"));
} else {
	$page->alert("You currently have no tasks!<br />This page normally lists your drafts, and any drafts sent to you for review.  To create a draft, edit a page and use the 'Save as draft' button.");
}

// Create page actions, both invisible at load
$page->addAction("Edit draft", array("domid"=>"draftedit", "hidden"=>true));
$page->addAction("Retrieve draft", array("domid"=>"retrievedraft", "hidden"=>true));

$page->set("title", "Your tasks");
$page->outputHTML();
?>