<?php
/**
 * Output the currently authenticated user's profile data as a JSON object
 *
 * Javascript file called dynamically from javascript (authlib) on
 * page load, once per "visit" (roughly every 40 minutes maximum -
 * stored in a cookie). Also called from Inferno and possibly other
 * off-platform services that need to authenticate ft.com users but
 * do not have local access to OAC.
 *
 * @codingstandard ftlabs-phpcs
 * @copyright The Financial Times Limited [All Rights Reserved]
 */

// Load required core libraries
require_once $_SERVER['CORE_PATH'].'/helpers/database/mysql/v4/connection';
require_once $_SERVER['CORE_PATH'].'/helpers/knownhost/v1/knownhost';
require_once $_SERVER['CORE_PATH'].'/helpers/http/HTTPRequest';
require_once $_SERVER['CORE_PATH'].'/helpers/errorhandler/v5/errorhandler';
require_once $_SERVER['CORE_PATH'].'/helpers/messaging/beanstalk/v2/beanstalk';
require_once $_SERVER['COREFTCO'].'/helpers/cacheability/cacheability';
require_once $_SERVER['COREFTCO'].'/helpers/auth/v2/ftsessionV2';
require_once $_SERVER['COREFTCO'].'/helpers/auth/v2/ftuserV2';
require_once $_SERVER['COREFTCO'].'/helpers/auth/v2/ftauthV2';

ErrorHandler::init();

// Authenticate the user.  Do not set a PHP session or redirect to registration
FTAuthV2::useSession(false);
FTAuthV2::disableRedirects();
$ftuser = FTAuthV2::authenticate();

// Do not allow this script to be cached
Cacheability::noCache();

// Get authentication data
$op = empty($ftuser) ? 'null' : $ftuser->getPublicUserStateJSON();

// Output data
if (!empty($_GET['jsonp'])) {
	echo $_GET['jsonp']."(".$op.");";
} else {
	echo $op;
}
